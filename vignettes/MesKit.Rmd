---
title: 'MesKit: Analyze and visualize Multi-region Whole-exome Sequencing Data'
output:
  html_document:
    df_print: paged
    highlight: pygments
    self_contained: yes
    theme: united
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
date: "`r Sys.Date()`"
---

<style type="text/css">
    .list-group-item.active,.list-group-item.active:focus,.list-group-item.active:hover {
    background-color: #007510;
    }
    body {
      font-family: Calibri, helvetica, sans-serif;
      font-size: 14px;
      line-height: 1.8;
    }
    h1 {
      font-size: 127%;
      color: #750400;
    }
    h2 {
      font-size: 121%;
      color: #750400;
    }    
    h3 {
      font-weight: bold;
      font-size: 109%;
      color: #750400;
      line-height: 2.4;
    }
    h4 {
      font-weight: bold;
      font-size: 100%;
      color: #750400;
      line-height: 2.1;
    }
    a, a:hover {
      color: #5bc227;
    }
</style>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```  
  
### 1. Introduction  
  
Intra-tumor heterogeneity (ITH) is now thought to be a key factor contributing to the therapeutic failures and drug resistance, which have attracted increasing attention in the cancer research. Here, we present an R package, MesKit, for characterizing cancer genomic ITH and inferring the history of tumor evolutionary . MesKit provides a wide range of analysis including ITH evaluation, enrichment, signature, clone evolution analysis via implementation of well-established computational and statistical methods. The source code and documents are freely available through Github (https://github.com/Niinleslie/MesKit). We also developed a shiny application to provide easier analysis and visualization.  
  

#### 1.1 Citation

In R console, enter ```citation("MesKit")```.  
  
_**MesKit: a tool kit for dissecting cancer evolution from multi-region derived tumor biopsies via somatic mutations**_
   
   
### 2. Prepare input Data  
  
To analyze with MesKit, you need to provide:  
  
* An MAF file of multiple tumors samples from the same person (named ```patientID.maf | patientID.maf.gz```). **Required**
* Cancer cell fraction (CCF) data of SSNVs. **Optional but recommended**
* A segmentation file. **Optional**
* The GISTIC output. **Optional**
  
#### 2.1 MAF files  
  
Mutation Annotation Format (MAF) files are tab-delimited text files with aggregated mutation information from VCF Files. The following fields are required to be contained in the MAF files with MesKit.  
  
**Mandatory fields:**  
  
```Hugo_Symbol```, ```Chromosome```, ```Start_Position```, ```End_Position```, ```Variant_Classification```, ```Variant_Type```, ```Reference_Allele```, ```Tumor_Seq_Allele2```, ```Ref_allele_depth```, ```Alt_allele_depth```, ```VAF```, ```Tumor_Sample_Barcode```.  

**Example MAF file**  
  
```{r echo=FALSE, paged.print=FALSE, rownames.print=FALSE}
MAFtable <- read.table(system.file("extdata", "HCC6046.maf", package = "MesKit"), header=TRUE)
extractLines <- rbind(MAFtable[1,],MAFtable[383, ])
extractLines <- rbind(extractLines,MAFtable[739, ])
data.frame(extractLines, row.names = NULL)
```  
  
  
#### 2.2 CCF files  
  
As for the CCF information, the column names of this file have to be: ```Sample```, ```Chromosome```, ```Start```, ```CCF```, ```CCF_std```, and the format used in the ```Chromosome``` field should be corresponding with the ```Chromosome``` field in the MAF file (both use number or both start with "chr").  


**Example CCF file**

```{r echo=FALSE, paged.print=FALSE, rownames.print=FALSE}
ccfInfo <- read.table(system.file("extdata", "HCC6046.CCF.txt", package = "MesKit"), header = TRUE)
ccfInfo[1:5, ]
```  
   

#### 2.3 Segmentation files

The segmentation file is a tab-delimited file with the following 5 or 6 columns:

* ```Sample``` - sample name
* ```Chromosome``` - chromosome name or ID
* ```Start``` - genomic start position of segments (1-indexed)
* ```End``` - genomic end position of segments (1-indexed)
* ```CopyNumber``` - absolute integer copy number
* ```SegmentMean``` - segment mean value, usually in log2 scale
Positions are in base pair units. The column names of a segmentation file is constant.

Users can upload the segmentation files that contain copy number information, which can be the original copy numbers or the log2 fold of one half of copy numbers and other necessary details.  
   
   
**Example Segmentation file**

```{r echo=FALSE, paged.print=FALSE, rownames.print=FALSE}
segInfo <- read.table(system.file("extdata", "HCC6046.seg.txt", package = "MesKit"), header = TRUE)
segInfo[1:5, ]
```  

   
#### 2.4 GISTIC output
   
In order to get more comprehensive results, users are able to upload the their own GISTIC resluts when the sample number is more than or equal to 30. Besides, users are allowed to download the GISTIC2 results corresponding to your cancer type from [http://gdac.broadinstitute.org](http://gdac.broadinstitute.org), and upload it as one of the parameters after you make sure the genome version based on these results is consistent with refBuild.
   
 
### 3. Installation  
  
  
#### Via GitHub 
Install the latest version of this package by typing the commands below in R console:  
  
```{r eval=FALSE}
install.packages("remotes")
remotes::install_github("Niinleslie/MesKit")
```  
  
  
  
### 4. Start with the Maf object  
  
```readMaf``` function creates an MAF object by reading MAF files and cancer cell fraction (CCF) data (Opitional but recommended). Parameter ```refBuild``` is used to set particular full genome sequences for Homo sapiens reference (```"hg18"```, ```"hg19"``` or ```"hg38"```). Besides, you can select the type of variant you are interested in by controlling the parameter ```mutType```, and the ```chrSilent``` parameter can be set to silent certain chromosome.
  
```{r message=FALSE}
library(MesKit)
```  
  
  
```{r}
maf.File <- system.file("extdata/", "HCC6046.maf", package = "MesKit")
ccf.File <- system.file("extdata/", "HCC6046.CCF.txt", package = "MesKit")
# Maf object generation
maf <- readMaf(mafFile = maf.File, refBuild = "hg19") 

# Maf object with CCF information
maf <- readMaf(mafFile = maf.File,
               ccfFile = ccf.File,
               refBuild = "hg19")  
```  

### 5. Mutational landscape

#### 5.1 Mutational profile   

SSNVs from MRS are divided into shared (shared by all samples), partial-shared (p-shared, observed in a subset of samples), private (unique to a single sample). Additionally, ```classifyMut``` function can distinguish clonal and subclonal SSNVs in each sample if CCF data is available (Criterion: clonal – 95% CI overlaps with 1; subclonal – the upper bound of 95% CI is smaller than 1(Clonal status of actionable driver events and the timing of mutational processes in cancer evolution).

```{r message=FALSE}
driverGene.file <- system.file("extdata/", "LIHC_driver_genes.txt", package = "MesKit")
mutType.mat <- classifyMut(maf, class = "SP", driverGenesFile = driverGene.file)
```


```{r message=FALSE, fig.align='left', fig.width=8, fig.height=5, warning=FALSE}
plotMutProfile(maf, class =  "SP", topGenesCount = 10, driverGenesFile = driverGene.file)
```
   

#### 5.2 CNA profile
The ```plotCNA``` function can accept copy number information generated from segmentation programmers and plot the CNA profile. 

```{r message=FALSE}
# Read segment file
segCN <- system.file("extdata", "HCC6046.seg.txt", package = "MesKit")
# Load reference file (The reference genome file should contain information about the location of genes)
load(system.file("extdata", "Homo_sapiens.GRCh37.75.RData", package = "MesKit"))

# Reading gistic output files
amp.genes <- system.file("extdata", "LIHC_amp_genes.conf_99.txt", package = "MesKit")
del.genes <- system.file("extdata", "LIHC_del_genes.conf_99.txt", package = "MesKit")

seg <- readSegment(segCN.file = segCN, ref.dat = gtf.dat,
                   gisticAmpGenesFile = amp.genes, gisticDelGenesFile = del.genes)
seg[,1:5]
```


```{r, error=TRUE, fig.width=11, fig.align='center'}
plotCNA(seg, show.GISTIC.gene = TRUE)
```  

   
### 6. Intra-tumor heterogeneity evaluation  

#### 6.1 Math score calculation

The ```mathScore``` function estimates ITH of single sample using MATH approach. Typically, the higher the MATH score, the more heterogeneous a tumor is.   
  
```{r}
mathScore(maf, minvaf = 0.02, maxvaf = 1)
```  

#### 6.2 AUC of CCF
The ```ccfAUC``` function estimates the tumor heterogeneity via the area under the curve (AUC) of the cumulative density from all cancer cell fractions per tumor.  Tumors with higher AUC are considered more heterogeneous.(Pan-cancer Immunogenomic Analyses Reveal Genotype-Immunophenotype Relationships and Predictors of Response to Checkpoint Blockade)  
   
```{r message=FALSE, fig.height=5, fig.width=6}
ccfAUC(maf)
```  

#### 6.3 VAF clustering
  
```vafCluster``` function clusters variant allele frequencies (VAFs) based on a Gaussian finite mixture model. This function produces a density distribution plot, depicting clusters of mutations with different VAFs in all/selected samples. We consider the number of clusters as a simple indicator of ITH.  
Parameters ```minVaf``` and ```maxVaf``` can be set to filter mutations. In addition, we offer several options for defining the plotting styles. Parameter `plotOption` could be set as ```"separate"```, ```"combine"``` or ```"compare"```, which means to generate a frequency map in different formats.  
  
```{r message=FALSE}
vafCluster(maf, plotOption = "combine", showMATH = TRUE)
```  
  

### 7. Intra-tumor heterogeneity evaluation
 
#### 7.1 Private/Shared mutation identification
  
For each patient, ```mutPrivateShared``` function identifies mutations shared by all samples as shared mutations (trunk mutations), mutations observed in a subset of samples as partial-shared mutations, and others which are unique to a single sample as private mutations (branch mutations). This function provides an overview of mutations using stack plots. Parameter ```show.num``` determines whether to show the numbers of mutations in the plot.  
  
```{r, fig.align='left', fig.width=7, fig.height=5}
mutPrivateShared(maf, show.num = FALSE)
```  
  
```mutOncoTSG``` function calculates the proportion of shared/partial-shared/private mutations that occur in oncogenes and tumor suppressor genes (TSGs), separately. The default oncogenes list and TSGs list of pan-cancer were collected from previous publications and public databases.  
  
```{r, fig.align='left', fig.width=5.5, fig.height=5}
oncogeneListFile <- system.file("extdata/", "oncogene.list.txt", package = "MesKit")
tsgListFile <- system.file("extdata/", "TSG.list.txt", package = "MesKit")
mutOncoTSG(maf, oncogeneListFile, tsgListFile, show.percentage = TRUE)
```  

#### 7.2 Fixation index

Fixation Index (Fst) estimation is a classical metric of population genetics, which can be used to measures the genetic divergence between regions [2](#refer) [3](#refer) [4](#refer). ```calFst``` function calculates the proportion of the total variance in allele frequency caused by frequency differences between populations.
```{r fig.align='left', fig.width=5.5, fig.height=5.5, fig.asp=1.0}
calFst(maf)
```  


### 8 Clonal origins inference 
The understanding of metastasis process and its routes are a relevant factor to contribute in the advance of actual and future of clinical treatments. Distinct patterns of monoclonal versus polyclonal seeding based on the cancer cell fraction (CCF) of SSNVs between primary/metastasis pairs. 

#### 8.1 Pairwise CCF comparison

```ccfDensity``` function prints pairwise CCF plots of mutations which are identified across samples from a single patient. Recent studies have used this method to deduce the potential metastatic route between different paired tumor lesions.  
  
```{r fig.align='left', fig.width=7, fig.height=3.5, message=FALSE, warning=FALSE}
ccf.pairwise <- ccfDensity(maf, show.density = TRUE)
cowplot::plot_grid(ccf.pairwise[[1]], ccf.pairwise[[2]])
```  

#### 8.2 Jaccard similarity index
  
```calJSI``` function calculates the Jaccard Similarity Index (JSI) for sample pairs from a single patient. JSI is defined for the intersection divided by the union of these two sets. Higher JSI values are more likely indicates polyclonal seeding [1](#refer). 
  
```{r fig.align='left', fig.width=5.5, fig.height=5.5, fig.asp=1.0}
calJSI(maf, plot = TRUE)
```  

### 9. Phylogenetic tree construction  
  
Based on the Maf object, ```getPhyloTree``` function reconstructs phylogenetic tree via different methods, including "NJ"(Neibor-Joining), "MP"(maximum parsimony) and "ML"(maximum likelihood), which can be set by controlling the ```method``` parameter, and stored in a ```phyloTree``` object, which is later utilized for functional analysis, mutational signature analysis and printing phylogenetic trees.  
  
```{r}
phylotree <- getPhyloTree(maf, method = "NJ")
```  
  
   
### 10. Functional exploration  
  
MesKit conducts enrichment analysis of Gene ontology (GO) and pathway using [ClusterProfiler](https://bioconductor.org/packages/release/bioc/html/clusterProfiler.html) R package. ```treeGO``` function and ```treePathway``` function returns enrichment results on both tree-level and branch-level. By default, ```treePathway``` function performs enrichment analysis of KEGG pathway and ```Reactome``` pathway is also available. Users can conduct enrichment of functional driver gene mutations specifically by providing a driver gene list.
  
  
#### 10.1 GO enrichment analysis
```{r, message=FALSE, warning=FALSE}
# Required org.Hs.eg.db
library("org.Hs.eg.db")

# GO enrichment analysis
GO.result <- treeGO(phylotree, driverGenesFile = driverGene.file, GO.type = "BP", 
                    pval = 0.05, pAdjustMethod = "BH", qval = 0.2, plotType = "dot", showCategory = 5)
names(GO.result$GO.category)
names(GO.result$GO.plot)
```
  
```{r, message=FALSE}
GO.result$GO.category[["SRR3670037"]]
```
  
```{r, fig.align='left', fig.height=4.5, fig.width=7, message=FALSE}
GO.result$GO.plot[["SRR3670037"]]
```
  
  
#### 10.2 Pathway enrichment analysis
```{r, message=FALSE, warning=FALSE}
# Pathway enrichment analysis
pathway.result <- treePathway(phylotree, driverGenesFile = driverGene.file, pathway.type = "KEGG",
                              pval = 0.05, pAdjustMethod = "BH", qval = 1, plotType = "dot", showCategory = 5)
```  
  
  
```{r message=FALSE}
pathway.result$pathway.category[["All"]]
```   
  
  
#### 10.3 Mutational signature analysis
  
```treeMutSig``` function identifies potential signatures for trunks/branches of phylogenetic trees. It returns a list containing three data frames, which can be passed to other functions for further analyses and visualization. This function is based on R package [deconstructSigs](https://github.com/raerose01/deconstructSigs) and you can set signatures matrix via ```signaturesRef``` (```cosmic``` or ```nature2013```). Parameter ```mutThreshold``` specifies the minimum number of mutations (Default: 50) required to perform mutation signature analysis. Moreover, if you provide a driver genes list via ```driverGenesFile```, then an additional column which records driver genes would be added to the final result. 
  
```{r, warning = FALSE, message=FALSE}
# Requires BSgenome.Hsapiens.UCSC.hg19 if you set refBuild = "hg19"
library("BSgenome.Hsapiens.UCSC.hg19")
```
   
```{r, warning = FALSE, message=FALSE}
tree.mutSig <- treeMutSig(phylotree,
                          driverGenesFile = driverGene.file)
```
   
   
```mutTrunkBranch``` function calculates the fraction of branch/trunk mutations occurring in each of the six types of base substitution types (C>A, C>G, C>T, T>A, T>C, T>G) and conducts paired Wilcoxon test. The confidence level can be tuned by parameter ```conf.level```.  
In the ```Significance``` column of the result, ```-```indicates that this group of mutation is not statistically significant, while ```*``` means it is significant.
   
```{r, warning = FALSE, message=FALSE}
mutTrunkBranch(tree.mutSig, conf.level = 0.95)
```


```plotTrunkBranch``` function prints the distribution of branch/trunk mutations, and especially presents corresponding p-values for significantly different base substitution types. 
   
```{r, warning = FALSE, message=FALSE}
plotTrunkBranch(tree.mutSig, conf.level = 0.95)
```

```mutSigSummary``` function takes the ```treeMutationalSig``` output and summarizes mutational signature of trunk/branches.  
   
```{r, warning = FALSE, message=FALSE}
mutSigSummary(tree.mutSig)
```
   
Furthermore, the mutational signature can be visualized using function ```plotMutSig```.   
   
```{r, warning = FALSE, message=FALSE, fig.height=6}
plotMutSig(tree.mutSig)
```
   
   
   
### 11. Phylogenetic tree visualization  
   
```plotPhyloTree``` function is aimed at visualizing phylogenetic trees. If ```show.mutSig = TRUE``` (Default), mutational signatures would be shown in different colors for each trunk and branch. Either binary mutation heatmap (indicates the presence or absence of a mutation) or ccf heatmap can be displayed by setting parameter `heatmap.type`.
  
  
#### 11.1 A phylogenetic tree along with binary heatmap of mutations  
  
  
```{r, fig.align='left', fig.width=8, fig.height=5, message=FALSE, warning=FALSE}
plotPhyloTree(phylotree, show.mutSig = TRUE, heatmap.type = "binary") 
```
  
  
#### 11.2 A phylogenetic tree along with CCF heatmap of mutations  
  
```{r, fig.align='left', fig.width=8, fig.height=5, message=FALSE, warning=FALSE}
plotPhyloTree(phylotree, show.mutSig = TRUE, heatmap.type = "CCF") 
```
  
   
### 12. References {#refer}
1. Hu Z, Li Z, Ma Z & Curtis C. Pan-cancer analysis of clonality and the timing of systemic spread in paired primary tumors and metastases. bioRXiv (2019). doi:10.1101/825240.

2. Weir, B.S. and Cockerham, C.C. Estimating F-Statistics for the Analysis of Population Structure. Evolution, 1984, 38, 1358-1370. [http://dx.doi.org/10.2307/2408641](http://dx.doi.org/10.2307/2408641)

3. Bhatia G , Patterson N , Sankararaman S , et al. Estimating and interpreting FST: The impact of rare variants[J]. Genome Research, 2013, 23(9):1514-1521.

4. Holsinger K E , Weir B S . Genetics in geographically structured populations: defining, estimating and interpreting FST[J]. Nature Reviews Genetics, 2009, 10(9):639-650.

  
### 13. Session Info
```{r}
sessionInfo()
```
  
  