#' @title readSegment
#'  
#' @param segFile The segment file
#' @param gisticAmpGenesFile Amplification Genes file generated by GISTIC. Default NULL.
#' @param gisticDelGenesFile Deletion Genes file generated by GISTIC. Default NULL.
#' @param gisticAllLesionsFile Information of all lesions generated by GISTIC. Default NULL.
#' @param gistic.qval The threshold of gistic Q value. Default is 0.25
#' @param verbose whether to display details in the console. Default True.
#' @param min.seg.size The smallest size of segments.Default is 500.
#' 
#' @examples
#' segFile <- system.file("extdata", "HCC6046.seg.txt", package = "MesKit")
#' gisticAmpGenesFile <- system.file("extdata", "LIHC_amp_genes.conf_99.txt", package = "MesKit")
#' gisticDelGenesFile <- system.file("extdata", "LIHC_del_genes.conf_99.txt", package = "MesKit")
#' gisticAllLesionsFile <- system.file("extdata", "LIHC_all_lesions.conf_99.txt", package = "MesKit")
#' seg <- readSegment(segFile = segFile,
#'                    gisticAmpGenesFile = gisticAmpGenesFile,
#'                     gisticDelGenesFile = gisticDelGenesFile, 
#'                    gisticAllLesionsFile = gisticAllLesionsFile )
#'
#' @return a combined segmentation data frame
#' @importFrom data.table foverlaps as.data.table setkey
#' @export readSegment
#'

readSegment <- function(segFile = NULL,
                        # ref.dat = NULL,
                        gisticAmpGenesFile = NULL, 
                        gisticDelGenesFile = NULL,
                        gisticAllLesionsFile = NULL,
                        gistic.qval = 0.25,
                        min.seg.size = 500,
                        verbose = TRUE){
  seg <- suppressWarnings(data.table::fread(segFile, header=TRUE, sep="\t", stringsAsFactors = FALSE))
  
  ## valid seg
  seg <- validSeg(seg)
  
  if(!"CopyNumber" %in% colnames(seg)){
    if("SegmentMean" %in% colnames(seg)){
        seg$SegmentMean <- as.numeric(seg$SegmentMean)
        suppressWarnings(seg[,CopyNumber := round(2^(SegmentMean)*2) ])
        seg <- dplyr::select(seg, Patient_ID, Tumor_Sample_Barcode, Chromosome, Start_Position, End_Position, CopyNumber)
    }
    else{
        stop("Error: segFile does not contain Copynumber or SegmentMean information")  
    }
  }
  seg$CopyNumber <- as.numeric(seg$CopyNumber)
  
  seg[ ,Width := End_Position - Start_Position]
  seg <- dplyr::mutate(seg, Type = unlist(lapply(seg$CopyNumber, function(x){
      if(x == 0){
          return("Deletion")
      }
      else if(x == 1){
          return("Loss")
      }
      else if(x == 2){
          return("Neutral")
      }
      else if(x == 3){
          return("Gain")
      }
      else if(x >=4){
          return("Amplification")
      }
  }))) %>%
      dplyr::filter(Chromosome %in% seq_len(22)& Width > min.seg.size) %>%
      dplyr::select(Patient_ID, Tumor_Sample_Barcode,Chromosome, Start_Position, End_Position, CopyNumber, Type) %>% 
       as.data.table()
  seg$Chromosome <- as.numeric(seg$Chromosome)
  seg$Start_Position <- as.numeric(seg$Start_Position)
  seg$End_Position <- as.numeric(seg$End_Position)
  data.table::setkey(x = seg, Chromosome, Start_Position, End_Position)
  
  gisticCNVgenes <- data.table::data.table()
  if(!is.null(gisticAmpGenesFile)){
      if(verbose){
          cat(paste0('--Processing ', basename(gisticAmpGenesFile), '\n'))
      }
      gisticAmpGenes <- readGisticGene(gisticAmpGenesFile, "AMP")
      gisticCNVgenes <- rbind(gisticCNVgenes, gisticAmpGenes)
  }   
  if(!is.null(gisticDelGenesFile)){
      if(verbose){
          cat(paste0('--Processing ', basename(gisticDelGenesFile), '\n'))
      }
      gisticDelGenes <- readGisticGene(gisticDelGenesFile, "Del")
      gisticCNVgenes <- rbind(gisticCNVgenes, gisticDelGenes)
  }
  gisticLesions <- data.table::data.table()
  if(!is.null(gisticAllLesionsFile)){
      gisticLesions <- as.data.table(readGisticAllLesions(gisticAllLesionsFile, verbose = verbose)) %>%
                       dplyr::rename(Wide_Peak_Boundaries = WPB)
      if("Amp" %in% gisticLesions$Gistic.type){
          gisticLesions[Gistic.type == "Amp",]$Gistic.type <- "AMP"
      }
  }
  if(nrow(gisticCNVgenes) != 0){
      if(!is.null(gisticAllLesionsFile)){
          gisticLesions$ID <- tidyr::unite(gisticLesions,"ID",Cytoband,Wide_Peak_Boundaries,Gistic.type,sep = "_")$ID
          gisticCNVgenes$ID <- tidyr::unite(gisticCNVgenes,"ID",Cytoband,Wide_Peak_Boundaries,Gistic.type,sep = "_")$ID
          gisticCNVgenes <- merge(gisticLesions,gisticCNVgenes,by = "ID") %>% 
                         dplyr::select(Cytoband.x, Wide_Peak_Boundaries.x, Gene, Gistic.type.x, Qvalue) %>%
                         dplyr::rename(Cytoband = Cytoband.x, Wide_Peak_Boundaries = Wide_Peak_Boundaries.x,
                                       Gistic.type = Gistic.type.x) %>%
                         dplyr::filter(Qvalue < gistic.qval) %>% data.table::as.data.table()
          
      }
      ## combine segment file and gistic results
      gisticCNVgenes[,Chromosome := sapply(strsplit(x = gisticCNVgenes[,Wide_Peak_Boundaries], split = ':'), '[', 1)]
      gisticCNVgenes[,loc := sapply(strsplit(x = gisticCNVgenes[,Wide_Peak_Boundaries], split = ':'), '[', 2)]
      gisticCNVgenes[,Start_Position := as.integer(sapply(strsplit(x = gisticCNVgenes[,loc], split = '-'), '[', 1))]
      gisticCNVgenes[,End_Position := as.integer(sapply(strsplit(x = gisticCNVgenes[,loc], split = '-'), '[', 2))]
      gisticCNVgenes[,Chromosome := gsub(pattern = 'chr', replacement = '', x = gisticCNVgenes$Chromosome, fixed = TRUE)]
      gisticCNVgenes[,Chromosome := gsub(pattern = 'X', replacement = '23', x = gisticCNVgenes$Chromosome, fixed = TRUE)]
      gisticCNVgenes[,Chromosome := gsub(pattern = 'Y', replacement = '24', x = gisticCNVgenes$Chromosome, fixed = TRUE)]
      gisticCNVgenes <- dplyr::select(gisticCNVgenes,Gene, Gistic.type, Chromosome, Start_Position, End_Position)
      gisticCNVgenes$Chromosome <- as.numeric(gisticCNVgenes$Chromosome)
      gisticCNVgenes$Start_Position <- as.numeric(gisticCNVgenes$Start_Position)
      gisticCNVgenes$End_Position <- as.numeric(gisticCNVgenes$End_Position)
      data.table::setkey(x = gisticCNVgenes,Chromosome, Start_Position, End_Position)
      mapDat <- data.table::foverlaps(gisticCNVgenes,seg, by.x = c("Chromosome","Start_Position","End_Position")) %>% 
                na.omit() %>% 
                dplyr::select(Patient_ID, Tumor_Sample_Barcode,Chromosome, Start_Position, End_Position, CopyNumber, Type, Gistic.type) %>% 
                dplyr::distinct(.)
      seg <- mapDat[(Type %in% c("Loss", "Deletion") & Gistic.type  == "Del")|(Type %in% c("Gain", "Amplification") & Gistic.type  == "AMP"),]
  }else if(nrow(gisticLesions) != 0){
      gisticLesions[,Chromosome := sapply(strsplit(x = gisticLesions[,Wide_Peak_Boundaries], split = ':'), '[', 1)]
      gisticLesions[,loc := sapply(strsplit(x = gisticLesions[,Wide_Peak_Boundaries], split = ':'), '[', 2)]
      gisticLesions[,Start_Position := as.integer(sapply(strsplit(x = gisticLesions[,loc], split = '-'), '[', 1))]
      gisticLesions[,End_Position := as.integer(sapply(strsplit(x = gisticLesions[,loc], split = '-'), '[', 2))]
      gisticLesions[,Chromosome := gsub(pattern = 'chr', replacement = '', x = gisticLesions$Chromosome, fixed = TRUE)]
      gisticLesions[,Chromosome := gsub(pattern = 'X', replacement = '23', x = gisticLesions$Chromosome, fixed = TRUE)]
      gisticLesions[,Chromosome := gsub(pattern = 'Y', replacement = '24', x = gisticLesions$Chromosome, fixed = TRUE)]
      gisticLesions <- dplyr::select(gisticLesions,Gistic.type, Chromosome, Start_Position, End_Position, Qvalue)
      gisticLesions$Chromosome <- as.numeric(gisticLesions$Chromosome)
      gisticLesions$Start_Position <- as.numeric(gisticLesions$Start_Position)
      gisticLesions$End_Position <- as.numeric(gisticLesions$End_Position)
      data.table::setkey(x = gisticLesions,Chromosome, Start_Position, End_Position) 
      mapDat <- data.table::foverlaps(gisticLesions,seg, by.x = c("Chromosome","Start_Position","End_Position")) %>% 
          na.omit() %>% 
          dplyr::filter(Qvalue < gistic.qval) %>% 
          dplyr::select(Patient_ID, Tumor_Sample_Barcode,Chromosome, Start_Position, End_Position, CopyNumber, Type, Gistic.type) %>%
          dplyr::distinct(.) %>% 
          data.table::as.data.table()
      seg <- mapDat[(Type %in% c("Loss", "Deletion") & Gistic.type  == "Del")|(Type %in% c("Gain", "Amplification") & Gistic.type  == "AMP"),]
  }
  
  
  data.table::setkey(x = seg, Patient_ID, Tumor_Sample_Barcode, Chromosome, Start_Position, End_Position)
  return(seg)
}


# extract recurrent CNA genes from gistic file
readGisticGene <- function(gisticGenesFile = NULL, Gistic.type = NULL){
    
    if(!is.null(gisticGenesFile)){
        gisticGenes <- data.table::fread(input = gisticGenesFile, stringsAsFactors = FALSE, header = TRUE)
        if(is.na(unique(gisticGenes[, ncol(gisticGenes), with = FALSE])[1])){     
            gisticGenes <- gisticGenes[,-ncol(gisticGenes), with = FALSE]
        }
        
        #wide peak boundaries
        wpb <- as.character(gisticGenes[3]) 
        wpb <- wpb[2:length(wpb)]
        
        # keep the information of peak boundaries and genes 
        gisticGenes <- gisticGenes[c(4:nrow(gisticGenes)),]
        gisticGenes$cytoband <- gsub(pattern = ' ', replacement = '_', x = gisticGenes$cytoband)
        colnames(gisticGenes) <- c( 'cytoband', paste0( colnames(gisticGenes)[2:length(colnames(gisticGenes))], '_',wpb))
        
        gisticGenes <- suppressWarnings(data.table::melt(gisticGenes, id.vars = 'cytoband'))
        gisticGenes <- gisticGenes[!value %in% '']
        
        #gisticGenes <- gisticGenes[!grep(pattern = '|', x = gisticGenes$value, fixed = TRUE)] #remove genes with ambiguous annotation
        gisticGenes <- gisticGenes[,.(variable, value)] %>%
            tidyr::separate(col = variable, into = c("Cytoband", "Wide_Peak_Boundaries"), 
                            sep = "_", remove = TRUE) %>%
            dplyr::mutate(Gene=sub("\\|.+", "", value), Gistic.type = Gistic.type) %>%
            dplyr::select(-value)
        
        return(gisticGenes)
    }
}

## read GISTIC all_lesions files
readGisticAllLesions <- function(gisticAllLesionsFile = NULL, verbose = TRUE){
    if(verbose){
        cat(paste0('--Processing ', basename(gisticAllLesionsFile), '\n'))
    }
    
    gisticLesions <- data.table::fread(input = gisticAllLesionsFile, stringsAsFactors = FALSE, header = TRUE)
    if(is.na(unique(gisticLesions[, ncol(gisticLesions), with = FALSE])[1])){     
        gisticLesions <- gisticLesions[,-ncol(gisticLesions), with = FALSE]
    }
    
    gisticLesions <- gisticLesions %>%
        dplyr::select(1,2,3,6) %>%
        `colnames<-` (c("PeakID", "Cytoband", "WPB", "Qvalue")) %>%
        dplyr::filter(!grepl("values", PeakID)) %>%
        dplyr::rowwise() %>%
        dplyr::mutate(WPB = strsplit(WPB, split = "(", fixed =  TRUE)[[1]][1]) %>%
        dplyr::mutate(Gistic.type = substr(PeakID, start = 1, stop = 3), PeakID = NULL) %>% as.data.table()
    
    return(gisticLesions)
}