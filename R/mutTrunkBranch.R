#' mutTrunkBranch
#' @description Summarize and conduct paired Wilcoxon test of mutations of trunk/branches in a phylogenetic tree.
#' 
#' @param phyloTree a phyloTree object generated by phyloTree function.
#' @param driverGenesFile The file with driver gene list. Default NULL.
#' @param min.mut.count the threshold for the variants in a branch. Default 15.
#' @param signaturesRef The parameter used for deconstructSig. Default "cosmic". Option: "nature2013". 
#' @param plot output a list of diagrams that visualize mutational signature of trunk/branches in a phylogenetic tree.Default FALSE. 
#' @param conf.level confidence level of the interval for wilcox.test. Default: 0.95. Option: on the scale of 0 to 1.
#' 
#' @examples
#' mutTrunkBranch(phyloTree)
#' mutTrunkBranch(phyloTree,plot = T)
#' 
#' @return  a list of box plots based on mutational categories
#' @export mutTrunkBranch

mutTrunkBranch <- function(phyloTree,
                           driverGenesFile=NULL,
                           min.mut.count=15,
                           signaturesRef="cosmic",
                           conf.level = 0.95,
                           plot = FALSE){
    treeMSOutput <- lapply(phyloTree, doTreeMutSig,
                           driverGenesFile = driverGenesFile,
                           min.mut.count = min.mut.count,
                           signaturesRef = signaturesRef)
    mutTrunkBranch.list <- suppressWarnings(lapply(treeMSOutput, doMutTrunkBranch,
                                   conf.level = conf.level))
    if(plot){
        TB.plot <- lapply(treeMSOutput, doPlotTrunkBranch,
                          conf.level = conf.level)
        return(list(mutTrunkBranch.list = mutTrunkBranch.list,
               TrunkBranch.plot = TB.plot))
    }
    return(mutTrunkBranch.list = mutTrunkBranch.list)
}

doMutTrunkBranch <- function(tree.mutSig, conf.level = 0.95){
    ## input data from tree.mutSig
    ls.BT <- .dataProcessBT(tree.mutSig)
    df.pValue <- ls.BT$df.pValue
    sigsInputBoxplot <- ls.BT$sigsInputBoxplot
    ls.mutationGroup <- c("C>A", "C>G", "C>T", "T>A", "T>C", "T>G")
    
    ## generate output data.frame with quantity of mutations in different categories
    output <- data.frame(matrix(nrow=6, ncol=2))
    colnames(output) <- c("Trunk", "Branch")
    output <- cbind(Group=ls.mutationGroup, output)
    output <- merge(output, df.pValue, by=c("Group"))
    output <- cbind(output, Significance=rep("-", nrow(output)))
    for (mutationGroup in ls.mutationGroup) {
        output$Branch[which(output$Group == mutationGroup)] <- sum(sigsInputBoxplot[which(
            sigsInputBoxplot$Group == mutationGroup & sigsInputBoxplot$BT == "Branch"),]$mut.num)
        output$Trunk[which(output$Group == mutationGroup)] <- sum(sigsInputBoxplot[which(
            sigsInputBoxplot$Group == mutationGroup & sigsInputBoxplot$BT == "Trunk"),]$mut.num)
        if (!is.null(output[which(output$p.value < (1-conf.level)), ]$Significance)) {
            output[which(output$p.value < (1-conf.level)), c("Significance")] <- "*"
        }
    }
    return(output)
}

.dataProcessBT <- function(tree.mutSig) {
    ## input data from tree.mutSig
    sigsInput <- tree.mutSig$sigsInput
    mutSigsOutput <- tree.mutSig$mutSigsOutput
    
    ## label the Trunk
    if (any(mutSigsOutput$alias == "T")){
        trunkName <- mutSigsOutput[which(mutSigsOutput$alias == "T"), ]$branch
    } else {
        stop("Trunk ERROR: There is no trunk mutation and the branch-trunk plot could not be plotted.
             Warnings and outputs from function getNJtree should be checked.")
    } 
    
    ## separate trunk and branch data
    sigsInput.trunk <- sigsInput[which(rownames(sigsInput) == trunkName), ]
    sigsInput.branch <- sigsInput[which(rownames(sigsInput) != trunkName), ]
    sigsInput.branch <- colSums(sigsInput.branch)
    sigsInputBT <- rbind(Trunk=sigsInput.trunk, Branch=sigsInput.branch)
    sigsInputBTTrans <- data.frame(Mutational_Type=colnames(sigsInputBT), t(sigsInputBT))
    ls.mutationGroup <- c("C>A", "C>G", "C>T", "T>A", "T>C", "T>G")
    
    ## generate Mutation Type for every column
    for (mutationGroup in ls.mutationGroup) {
        sigsInputBTTrans$Group[which(grepl(mutationGroup, sigsInputBTTrans$Mutational_Type))] <- mutationGroup
    }
    
    sigsInputBSum <- sigsInputBTTrans %>% dplyr::group_by(Group) %>% dplyr::summarise(sum = sum(Branch))
    sigsInputTSum <- sigsInputBTTrans %>% dplyr::group_by(Group) %>% dplyr::summarise(sum = sum(Trunk))
    
    sigsInputBTTrans <- cbind(sigsInputBTTrans, 
                              BranchFrac=rep(0, nrow(sigsInputBTTrans)), 
                              TrunkFrac=rep(0, nrow(sigsInputBTTrans)))
    for (mutationGroup in ls.mutationGroup) {
        groupBSum <- sigsInputBSum$sum[which(sigsInputBSum$Group == mutationGroup)]
        if (groupBSum == 0) {
            sigsInputBTTrans[which(sigsInputBTTrans$Group == mutationGroup), ]$Branch <- 0
        }
        groupTSum <- sigsInputTSum$sum[which(sigsInputTSum$Group == mutationGroup)]
        if (groupBSum == 0) {
            sigsInputBTTrans[which(sigsInputBTTrans$Group == mutationGroup), ]$Trunk <- 0
        }
        
        sigsInputBTTrans[which(sigsInputBTTrans$Group == mutationGroup), ]$BranchFrac <- 
            100*sigsInputBTTrans[which(sigsInputBTTrans$Group == mutationGroup), ]$Branch/groupBSum
        sigsInputBTTrans[which(sigsInputBTTrans$Group == mutationGroup), ]$TrunkFrac <- 
            100*sigsInputBTTrans[which(sigsInputBTTrans$Group == mutationGroup), ]$Trunk/groupTSum
    }
    
    sigsInputBoxplot <- data.frame(matrix(nrow=0, ncol=5))
    colnames(sigsInputBoxplot) <- c("GroupBT", "Group", "BT", "mut.frac", "mut.num")
    for (mutationGroup in ls.mutationGroup) {
        dat.group <- sigsInputBTTrans[which(sigsInputBTTrans$Group == mutationGroup), ]
        df.groupT <- data.frame(rep(paste(mutationGroup, "Trunk", sep=" "), nrow(dat.group)), 
                                rep(mutationGroup, nrow(dat.group)), 
                                rep("Trunk", nrow(dat.group)),
                                dat.group$TrunkFrac, 
                                dat.group$Trunk)
        df.groupB <- data.frame(rep(paste(mutationGroup, "Branch", sep=" "), nrow(dat.group)), 
                                rep(mutationGroup, nrow(dat.group)), 
                                rep("Branch", nrow(dat.group)), 
                                dat.group$BranchFrac, 
                                dat.group$Branch)
        colnames(df.groupB) <- c("GroupBT", "Group", "BT", "mut.frac", "mut.num")
        colnames(df.groupT) <- c("GroupBT", "Group", "BT", "mut.frac", "mut.num")
        sigsInputBoxplot <- rbind(sigsInputBoxplot, df.groupT, df.groupB)
    }
    
    df.pValue <- data.frame(matrix(ncol = 2, nrow = 0))
    colnames(df.pValue) <- c("Group", "p.value")
    for (mutationGroup in ls.mutationGroup) {
        pValue <- wilcox.test(
            sigsInputBoxplot[
                which(sigsInputBoxplot$Group == mutationGroup & 
                          sigsInputBoxplot$BT == "Branch"), ]$mut.frac, 
            sigsInputBoxplot[
                which(sigsInputBoxplot$Group == mutationGroup & 
                          sigsInputBoxplot$BT == "Trunk"), ]$mut.frac, 
            paired=TRUE, alternative = "two.sided", conf.level=conf.level, 
            exact=FALSE
        )$p.value
        row.pValue <- data.frame(mutationGroup, pValue)
        colnames(row.pValue) <- c("Group", "p.value")
        df.pValue <- rbind(df.pValue, row.pValue)
    }
    output <- list(df.pValue=df.pValue, sigsInputBoxplot=sigsInputBoxplot)
    return(output)
}


doPlotTrunkBranch <- function(tree.mutSig, conf.level){
    ## input data from tree.mutSig
    ls.BT <- .dataProcessBT(tree.mutSig)
    df.pValue <- ls.BT$df.pValue
    sigsInputBoxplot <- ls.BT$sigsInputBoxplot
    
    ## p values of mutational list
    if (df.pValue[which(df.pValue$Group == "C>A"), ]$p.value < (1-conf.level)) {
        CApV <- grid::textGrob(paste("p = ", as.character(
            round(df.pValue[which(df.pValue$Group == "C>A"), ]$p.value, 
                  digits = 3)), "*", sep=""), 
            gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)    
    } else {
        CApV <- grid::textGrob(expression(""), 
                               gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75) 
    }
    
    if (df.pValue[which(df.pValue$Group == "C>G"), ]$p.value < (1-conf.level)) {
        CGpV <- grid::textGrob(paste("p = ", as.character(
            round(df.pValue[which(df.pValue$Group == "C>G"), ]$p.value, 
                  digits = 3)), "*", sep=""), 
            gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    } else {
        CGpV <- grid::textGrob(expression(""), 
                               gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    }
    
    if (df.pValue[which(df.pValue$Group == "C>T"), ]$p.value < (1-conf.level)) {
        CTpV <- grid::textGrob(paste("p = ", as.character(
            round(df.pValue[which(df.pValue$Group == "C>T"), ]$p.value, 
                  digits = 3)), "*", sep=""), 
            gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    } else {
        CTpV <- grid::textGrob(expression(""), 
                               gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    }
    
    if (df.pValue[which(df.pValue$Group == "T>A"), ]$p.value < (1-conf.level)) {
        TApV <- grid::textGrob(paste("p = ", as.character(
            round(df.pValue[which(df.pValue$Group == "T>A"), ]$p.value, 
                  digits = 3)), "*", sep=""),
            gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    } else {
        TApV <- grid::textGrob(expression(""), 
                               gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    }
    
    if (df.pValue[which(df.pValue$Group == "T>C"), ]$p.value < (1-conf.level)) {
        TCpV <- grid::textGrob(paste("p = ", as.character(
            round(df.pValue[which(df.pValue$Group == "T>C"), ]$p.value, 
                  digits = 3)), "*", sep=""),
            gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    } else {
        TCpV <- grid::textGrob(expression(""), 
                               gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    }
    
    if (df.pValue[which(df.pValue$Group == "T>G"), ]$p.value < (1-conf.level)) {
        TGpV <- grid::textGrob(paste("p = ", as.character(
            round(df.pValue[which(df.pValue$Group == "T>G"), ]$p.value, 
                  digits = 3)), "*", sep=""),
            gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    } else {
        TGpV <- grid::textGrob(expression(""), 
                               gp=grid::gpar(fontsize=12),vjust=0,hjust=0.75)
    }
    
    ## names of mutational list
    CA <- grid::textGrob(expression(bold("C > A")),
                         gp=grid::gpar(fontsize=12, fontface="bold"),vjust=0,hjust=1)
    CG <- grid::textGrob(expression(bold("C > G")),
                         gp=grid::gpar(fontsize=12, fontface="bold"),vjust=0,hjust=1)
    CT <- grid::textGrob(expression(bold("C > T")),
                         gp=grid::gpar(fontsize=12, fontface="bold"),vjust=0,hjust=1)
    TA <- grid::textGrob(expression(bold("T > A")),
                         gp=grid::gpar(fontsize=12, fontface="bold"),vjust=0,hjust=1)
    TC <- grid::textGrob(expression(bold("T > C")),
                         gp=grid::gpar(fontsize=12, fontface="bold"),vjust=0,hjust=1)
    TG <- grid::textGrob(expression(bold("T > G")),
                         gp=grid::gpar(fontsize=12, fontface="bold"),vjust=0,hjust=1)
    
    group.colors <- c("#E64B35FF", "#4DBBD5FF", "#00A087FF",
                      "#3C5488FF", "#F39B7FFF", "#8491B4FF")
    
    pic <- ggplot(sigsInputBoxplot, aes(x=GroupBT, y=mut.frac, fill=Group)) + 
        geom_boxplot(coef=100) + 
        ggtitle(paste0("Substitution types of ",tree.mutSig$patientID,"'s phylogenetic tree ")) + 
        theme(panel.grid=element_blank(), 
              panel.border=element_blank(), 
              panel.background = element_blank(), 
              legend.position='none', 
              plot.title = element_text(size = 13,face = "bold",hjust = 0.5,vjust = 0),
              axis.text.x=element_text(size=10, angle = 90, vjust = 0.5, hjust=1), 
              axis.ticks.x = element_blank(), 
              axis.text.y=element_text(size=10)) + 
        ## background colors
        geom_rect(aes(xmin=0.5, xmax=2.5, ymin=0, ymax=104),
                  fill="#fce7e4", alpha=0.15) + 
        geom_rect(aes(xmin=2.5, xmax=4.5, ymin=0, ymax=104),
                  fill="#ecf8fa", alpha=0.25) + 
        geom_rect(aes(xmin=4.5, xmax=6.5, ymin=0, ymax=104),
                  fill="#dbfff9", alpha=0.05) + 
        geom_rect(aes(xmin=6.5, xmax=8.5, ymin=0, ymax=104),
                  fill="#e4e8f3", alpha=0.08) + 
        geom_rect(aes(xmin=8.5, xmax=10.5, ymin=0, ymax=104),
                  fill="#fdefeb", alpha=0.15) + 
        geom_rect(aes(xmin=10.5, xmax=12.5, ymin=0, ymax=104),
                  fill="#e5e8ef", alpha=0.1) + 
        geom_boxplot(coef=100) + 
        ## color setting
        scale_fill_manual(values=group.colors) + 
        ## axis setting
        scale_x_discrete(name = "", labels=c( "Trunk","Branch", "Trunk", "Branch",  
                                              "Trunk", "Branch",  "Trunk", "Branch", 
                                              "Trunk", "Branch",  "Trunk","Branch")) + 
        scale_y_continuous(name = "Mutation fraction(%)", limits=c(-5, 104), breaks=seq(0, 100, 25)) + 
        coord_cartesian(ylim = c(0,100), expand = TRUE) + 
        ## x axis bar
        geom_rect(aes(xmin=0.5, xmax=2.5, ymin=-5, ymax=-0.5),
                  fill=group.colors[1], alpha=1) + 
        geom_rect(aes(xmin=2.5, xmax=4.5, ymin=-5, ymax=-0.5),
                  fill=group.colors[2], alpha=0.25) + 
        geom_rect(aes(xmin=4.5, xmax=6.5, ymin=-5, ymax=-0.5),
                  fill=group.colors[3], alpha=0.05) + 
        geom_rect(aes(xmin=6.5, xmax=8.5, ymin=-5, ymax=-0.5),
                  fill=group.colors[4], alpha=0.08) + 
        geom_rect(aes(xmin=8.5, xmax=10.5, ymin=-5, ymax=-0.5),
                  fill=group.colors[5], alpha=0.15) + 
        geom_rect(aes(xmin=10.5, xmax=12.5, ymin=-5, ymax=-0.5),
                  fill=group.colors[6], alpha=0.1) + 
        ## Mutational Type Labels
        annotation_custom(grob = CA,  xmin = 1, xmax = 3, ymin = -8.5, ymax = -0) + 
        annotation_custom(grob = CG,  xmin = 3, xmax = 5, ymin = -8.5, ymax = -0) + 
        annotation_custom(grob = CT,  xmin = 5, xmax = 7, ymin = -8.5, ymax = -0) + 
        annotation_custom(grob = TA,  xmin = 7, xmax = 9, ymin = -8.5, ymax = -0) + 
        annotation_custom(grob = TC,  xmin = 9, xmax = 11, ymin = -8.5, ymax = -0) + 
        annotation_custom(grob = TG,  xmin = 11, xmax = 13, ymin = -8.5, ymax = -0) + 
        ## Mutational Type p value of wilcox.test
        
        annotation_custom(grob = CApV,  xmin = 1.5, xmax = 3, ymin = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "C>A"), ]), ymax = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "C>A"), ])) +
        annotation_custom(grob = CGpV,  xmin = 3.5, xmax = 5, ymin = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "C>G"), ]), ymax = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "C>G"), ])) +
        annotation_custom(grob = CTpV,  xmin = 5.5, xmax = 7, ymin = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "C>T"), ]), ymax = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "C>T"), ])) +
        annotation_custom(grob = TApV,  xmin = 7.5, xmax = 9, ymin = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "T>A"), ]), ymax = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "T>A"), ])) +
        annotation_custom(grob = TCpV,  xmin = 9.5, xmax = 11, ymin = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "T>C"), ]), ymax = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "T>C"), ])) +
        annotation_custom(grob = TGpV,  xmin = 11.5, xmax = 13, ymin = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "T>G"), ]), ymax = getYmax(sigsInputBoxplot[which(sigsInputBoxplot$Group == "T>G"), ]))
    #message("Branch-trunk plot generation done!")
    
    return(pic)
}

getYmax <- function(BT.dat){
    BT.dat <- as.data.table(BT.dat)
    Branch.mutfrac <- BT.dat[BT == "Branch"]$mut.frac
    Branch.outlier <- boxplot(Branch.mutfrac,range = 100,plot = FALSE)$out
    Branch.ymax <- max(Branch.mutfrac[!Branch.mutfrac %in% Branch.outlier]) 
    Trunk.mutfrac <- BT.dat[BT == "Trunk"]$mut.frac
    Trunk.outlier <- boxplot(Trunk.mutfrac,range = 100, plot = FALSE)$out
    Trunk.ymax <- max(Trunk.mutfrac[!Trunk.mutfrac %in% Trunk.outlier])
    return(max(Trunk.ymax,Branch.ymax)+ 4)
}