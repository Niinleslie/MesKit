#' @title ccfDensity
#' @description Density plot of CCFs in paired samples of the patient
#' This function requires CCF for clustering
#' @param maf a Maf object generated by readMaf function.
#' @param patient.id select the specific patients. Default: NULL, all patients are included
#' @param show.density logical. If TRUE, the default, perform density estimation.
#' 
#' @return
#' @examples
#' ccfDensity(maf, show.density = T)
#' @export ccfDensity


compareCCF <- function(mafData, show.density = TRUE){
  samples <- unique(mafData$Tumor_Sample_Barcode)

  pairs <- combn(length(samples), 2, simplify = FALSE)  
  p <- list()
  p.name <- c()
  i <- 1
  for (pair in pairs){
    S1 <- samples[pair[1]]
    S2 <- samples[pair[2]]
    ccf.pair <- mafData %>% dplyr::filter(Tumor_Sample_Barcode %in% c(S1, S2)) %>%
      tidyr::unite("mutation_id", c("Chromosome", "Start_Position", "Reference_Allele", "Tumor_Seq_Allele2"), 
        sep = ":", remove = FALSE) %>% 
      dplyr::select(Tumor_Sample_Barcode, mutation_id, CCF) %>% 
      tidyr::spread(key = Tumor_Sample_Barcode, value = CCF)

    colnames(ccf.pair) <- c("mutation_id", "sample1", "sample2")    
    p[[i]] <- ggplot2::ggplot(data=ccf.pair, aes(x=sample1, y=sample2)) + 
      geom_point(size = 0.5) + xlab(S1) +ylab(S2) +
      xlim(0,1) + ylim(0,1) +
      theme(legend.text = element_text(size=10, face="bold"))+
      theme(legend.title = element_text(size=11, face="bold")) +
      guides(shape = guide_legend(override.aes = list(size = 0.2))) +
      theme_bw() + coord_fixed() +
      theme(panel.background = element_blank()) +
      theme(panel.background = element_rect(colour = "black", size = 0.4)) +
      labs(x = S1, y = S2) +
      ggtitle(paste("CCF density plot in paired samples:\n ", S1, "——", S2, sep = "")) +
      theme(plot.title = element_text(hjust = 0.5))
    
    if(show.density){
      p[[i]] <- p[[i]] + stat_density_2d(aes(fill = ..level..), geom = 'polygon', n = ) +
      scale_fill_gradient(low = "#8491B499", high = "#E64B35FF")
    }
    p.name <- c(p.name, paste(S1,"-",S2, sep = ""))
    i =  i+1
  }
  
  names(p) <- p.name
  return(p)  
}


ccfDensity <- function(maf, patient.id = NULL, min.ccf = 0, show.density = TRUE){
  mafData <- maf@data

  ## check if ccf data is provided
  if(! "CCF" %in% colnames(mafData)){
    stop(paste0("ccfDensity function requires CCF data.\n",
    "No CCF data was found when generate Maf object."))
  }

  if(is.null(patient.id)){
      patient.id = unique(mafData$Patient_ID)
  }else{
      patient.setdiff <- setdiff(patient.id, unique(mafData$Patient_ID))
      if(length(patient.setdiff) > 0){
          stop(paste0(patient.setdiff, " can not be found in your data"))
      }
  }

  
  density.list <- mafData %>%
      dplyr::filter(Patient_ID %in% patient.id & CCF > min.ccf) %>%
      dplyr::group_by(Patient_ID) %>%
      dplyr::group_map(., ~compareCCF(.x, show.density = show.density), keep=TRUE) %>%
      rlang::set_names(patient.id)

  return(density.list)      
}
