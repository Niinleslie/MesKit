#' @title plotCNA
#'  
#' @param seg object generated by readSegment function.
#' @param sample.as.col Whether to use samples as each column of the heat map.Default FALSE.
#' @param show.GISTIC.gene Whether GISTIC gene in seg.Default FALSE.
#' 
#' @examples
#' segCN.file <- system.file("extdata", "HCC6046.seg.txt", package = "MesKit")
#' # Load gtf.dat
#' load(system.file("extdata", "Homo_sapiens.GRCh37.75.RData", package = "MesKit"))
#' gisticAmpGenesFile <- system.file("extdata", "LIHC_amp_genes.conf_99.txt", package = "MesKit")
#' gisticDelGenesFile <- system.file("extdata", "LIHC_del_genes.conf_99.txt", package = "MesKit")
#' seg <- readSegment(segCN.file = segCN.file, gtf.dat = gtf.dat, gisticAmpGenesFile = gisticAmpGenesFile, gisticDelGenesFile = gisticDelGenesFile)
#' plotCNA(seg)
#'
#' @import ComplexHeatmap
#' @export plotCNA
#'

plotCNA <- function(seg, sample.as.col = FALSE, show.GISTIC.gene = FALSE){
  if(show.GISTIC.gene){
    if(!"Gistic.type" %in% colnames(seg)){
      stop("seg does not contain GISTIC gene information")
    }
  }
  s <- seg[,round(mean(CopyNumber)),by = .(Sample,Gene)]
  matDat <- dplyr::mutate(s, Type = unlist(lapply(s$V1, function(x){
    if(x == 0){
      return("Deletion")
    }
    else if(x == 1){
      return("Loss")
    }
    else if(x == 2){
      return(NA)
    }
    else if(x == 3){
      return("Gain")
    }
    else if(x >=4){
      return("Amplification")
    }
  })))%>% as.data.table() %>% dcast(Gene~ Sample, value.var = "Type")
  geneOrder <- factor(matDat$Gene, levels = unique(s[,Gene]))
  matDat <- matDat[order(geneOrder), ]
  mat <- as.matrix(matDat[,-1])
  # rownames(mat) <- matDat[,Gene]
  colType <- c("Loss" = "#6baed6", "Deletion" = "#084594",
                "Gain" = "#f4a582","Amplification" = "#d73027")
  if(sample.as.col){
    ComplexHeatmap::Heatmap(mat, col = colType, name = "Type", na_col = "#f0f0f0", row_labels = rownames(mat))
  }
  else{
    ComplexHeatmap::Heatmap(t(mat), col = colType, name = "Type", na_col = "#f0f0f0", row_names_side = "left", column_labels = colnames(t(mat)))
  }
}