#' calFst
#' @description Nei's distance of CCF for each sample-pair
#' @references Lee JK, Wang J, Sa JK, et al. Spatiotemporal genomic architecture informs precision oncology in glioblastoma. 
#' Nat Genet. 2017;49(4):594–599. doi:10.1038/ng.3806
#' 
#' @param maf an Maf object generated by readMaf function
#' @param patient.id select the specific patients. Default: NULL, all patients are included
#' @param min.VAF specify the minimum CCF value of subclonal mutations
#' @param plot logical, default TRUE
#' @param use.circle, default FALSE
#' @return Nei's genetic distance matrix of sample-pairs from the same patient
#'
#' @examples
#' calNeiDist(maf)
#' @export calNeiDist

nei_dist <- function(df) {
    df <- tidyr::pivot_wider(df,
            names_from = Tumor_Sample_Barcode,
            values_from = CCF,
            values_fill = list(CCF = 0)
    ) %>%
    dplyr::select(-Patient_ID, -mutation_id)

    dist <- diag(0, nrow = ncol(df), ncol = ncol(df))
    
    for (i in 1:(ncol(df) - 1)) {
        for (j in (i + 1):ncol(df)) {
            x <- as.vector(df[, i])
            y <- as.vector(df[, j])
            
            x_ <- sum(x ^ 2 + (1 - x) ^ 2)
            y_ <- sum(y ^ 2 + (1 - y) ^ 2)
            
            xy <- sum(x * y + (1 - x) * (1 - y))
            
            dist[i, j] <- dist[j, i] <- -log(xy / sqrt(x_ * y_))
        }
    }
    rownames(dist) <- colnames(df)
    colnames(dist) <- colnames(df)


    return(dist)
}

calNeiDist <- function(maf, patient.id = NULL, plot = TRUE, use.circle = TRUE, title = "Nei's distance") {
    mafData <- maf@data

    if(! "CCF" %in% colnames(mafData)){
        stop(paste0("Calculation of Nei’s distance requires CCF data." ,
            "No CCF data was found when generate Maf object with readMaf function"))
    }

    if(is.null(patient.id)){
        patient.id = unique(mafData$Patient_ID)
    }else{
        patient.setdiff <- setdiff(patient.id, unique(mafData$Patient_ID))
        if(length(patient.setdiff) > 0){
            stop(paste0(patient.setdiff, " can not be found in your data"))
        }
    }


    Nei.dist <- mafData %>%
        dplyr::filter(Patient_ID %in% patient.id) %>%
        tidyr::unite(
            "mutation_id",
            c(
                "Chromosome",
                "Start_Position",
                "Reference_Allele",
                "Tumor_Seq_Allele2"
            ),
            sep = ":",
            remove = FALSE
        ) %>%
        dplyr::select(
            mutation_id,
            Tumor_Sample_Barcode,
            Patient_ID,
            CCF) %>%
        dplyr::mutate(
            CCF = dplyr::if_else(is.na(CCF), 0, CCF)
        ) %>%
        dplyr::group_by(Patient_ID) %>%
        dplyr::group_map(~nei_dist(.), keep = TRUE) %>%
        rlang::set_names(patient.id)

    Nei.plot = list()
    if(plot){
        for(i in 1:length(Nei.dist)){
            Nei.plot[[i]] <- plotCorr(Nei.dist[[i]], use.circle = use.circle, title = title)
        }
        names(Nei.plot) <- patient.id
    }

   return(list(Nei.dist = Nei.dist, Nei.plot =  Nei.plot))           

}
