#' calFst
#' @description Nei's distance of CCF for each sample-pair
#' @references Lee JK, Wang J, Sa JK, et al. Spatiotemporal genomic architecture informs precision oncology in glioblastoma. 
#' Nat Genet. 2017;49(4):594–599. doi:10.1038/ng.3806
#' 
#' @param maf an Maf object generated by readMaf function
#' @param patient.id select the specific patients. Default: NULL, all patients are included
#' @param min.vaf specify the minimum VAF, default is 0.08
#' @param plot logical (Default:TRUE). Whether to show the plot, default TRUE
#' @param use.circle logical (Default:TRUE). Whether to use "circle" as visualization method of correlation matrix
#' default TURE
#' @param title the title of the plot, default is "Nei's distance"
#' @param withinType calculate fst within types in each patients,default is FALSE.
#' 
#' @return Nei's genetic distance matrix and heatmap of sample-pairs from the same patient
#'
#' @examples
#' calNeiDist(maf)
#' @export calNeiDist

calNeiDist <- function(maf, 
    patient.id = NULL, 
    min.vaf = 0.08,
    # max.vaf = 1,
    plot = TRUE, 
    use.circle = TRUE, 
    title = NULL,
    withinType = FALSE) {
    
    mafData <- maf@data

    if(! "CCF" %in% colnames(mafData)){
        stop(paste0("Calculation of Nei’s distance requires CCF data." ,
            "No CCF data was found when generate Maf object with readMaf function"))
    }

    if(is.null(patient.id)){
        patient.id = unique(mafData$Patient_ID)
    }else{
        patient.setdiff <- setdiff(patient.id, unique(mafData$Patient_ID))
        if(length(patient.setdiff) > 0){
            stop(paste0("Patient ", patient.setdiff, " can not be found in your data"))
        }
    }
     
    if(min.vaf < 0){
        stop("Error: min.vaf must be greater than 0")
    }
    
    if(withinType){
        if(!"Clonal_Status" %in% colnames(mafData)){
            stop("Clonal_Status of mutations should be contained in MAF when withinType is TRUE") 
        }
        mafData <- mafData %>% 
            dplyr::filter(Clonal_Status == "Subclonal")
    }
    input_data <- mafData %>%
        dplyr::filter(Patient_ID %in% patient.id) %>% 
        dplyr::mutate(
            CCF = dplyr::if_else(is.na(CCF), 0, CCF)
        ) %>% 
        dplyr::filter(VAF_adj > min.vaf)%>% 
        dplyr::select(
                Mut_ID,
                Tumor_Type,
                Tumor_Sample_Barcode,
                Patient_ID,
                CCF) %>%
            data.table::as.data.table()
    ## fresh patient id
    patient.id <- unique(input_data$Patient_ID)
    Nei.plot <- list()
    Nei.avg <- list()
    avg.list <- c()
    # df.list <- list()
    mat.list <- list()
    if(withinType){
        Nei.dist <- input_data %>% 
            dplyr::group_by(Patient_ID) %>%
            dplyr::group_map(~groupByTypeND(.), keep = TRUE) %>%
            rlang::set_names(patient.id)
        
        dist.list <- list()
        type.list <- c()
        patient.list <- c()
        for(patient in names(Nei.dist)){
            
            ## get result for each patient
            Nei.dist.p <- Nei.dist[[patient]]
            
            for(type in names(Nei.dist.p)){
                
                name <- paste0(patient,"_",type) 
                ## get result for each patient in each type
                Nei.dist.p.t <- Nei.dist.p[[type]]$dist.mat
                mat.list[[name]] <- Nei.dist.p.t
                # df <- Nei.dist.p[[type]]$dist.df
                # df$type <- name
                # df.list[[type]] <- df
                
                type.list <- c(type.list, type)
                patient.list <- c(patient.list,patient)
                ## get average dist
                avg <- mean(Nei.dist.p.t)
                avg.list <- c(avg.list,avg)
                
                if(plot){
                    Nei.plot[[name]] <- plotCorr(
                        Nei.dist.p.t, 
                        use.circle = use.circle, 
                        title = if(!is.null(title)) title else{paste0("Nei's distance of ",type, " in ", patient,
                                                                      ": ",round(avg,2))}
                    )
                }
                
            }
        }
        # Nei.dist <- plyr::rbind.fill(df.list)
        # colnames(Nei.dist) <- c("Patient_ID","Pair","Nei.dist","Tumor_Type")
        # Nei.dist <- Nei.dist %>%  
        #     dplyr::select(Patient_ID, Tumor_Type, Pair, Nei.dist)
        
        Nei.avg <- data.frame(Patient_ID = patient.list,
                              Tumor_Type = type.list,
                              Nei.dist.avg = avg.list)
        
    }
    else{
        Nei.dist <- input_data %>% 
            dplyr::group_by(Patient_ID) %>%
            dplyr::group_map(~nei_dist(., withinType = withinType), keep = TRUE) %>%
            rlang::set_names(patient.id) 
        
        Nei.dist <- Nei.dist[!is.na(Nei.dist)]
        patient.id <- names(Nei.dist)
        # df.list
        for(i in 1:length(Nei.dist)){
            patient <- patient.id[[i]]
            avg <- mean(Nei.dist[[i]]$dist.mat)
            avg.list <- append(avg.list,avg)
            mat.list[[patient]] <- Nei.dist[[i]]$dist.mat
            # df.list[[i]] <- Nei.dist[[i]]$dist.df
            if(plot){
                Nei.plot[[patient.id[i]]] <- plotCorr(
                    Nei.dist[[i]]$dist.mat, 
                    use.circle = use.circle, 
                    title = if(!is.null(title)) title else{paste0("Nei's distance of patient ", patient.id[i],
                                                                  ": ",round(avg,2))}
                    #paste0(Nei’s distance, " of patient ", patient.id[i])
                )
            }
        }
        # Nei.dist <- plyr::rbind.fill(df.list)
        # colnames(Nei.dist) <- c("Patient_ID","Pair","Nei.dist")
        Nei.avg <- data.frame(Patient_ID = patient.id,
                              Nei.dist.avg = avg.list)
    }
    
    if(plot){
        return(list(Nei.dist.avg = Nei.avg, Nei.dist = mat.list, Nei.plot =  Nei.plot))           
    }
    else{
        return(list(Nei.dist.avg = Nei.avg, Nei.dist = mat.list))           
    }

}
