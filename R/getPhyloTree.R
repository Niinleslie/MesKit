#' @title getPhyloTree
#' 
#' @import phangorn
#' @param a Maf object generated by readMaf function
#' @param method Approach to construct phylogenetic trees.Choose one of "NJ"(Neibor-Joining),"MP"(maximum parsimony),"ML"(maximum likelihood). 
#' @param minVaf the minimum value of vaf
#' @param maxVaf the maximum value of vaf
#' 
#' 
#' @examples
#' maf.File <- system.file("extdata", "HCC6046.maf", package = "MesKit")
#' ccf.File <- system.file("extdata", "HCC6046.CCF.txt", package = "MesKit")
#' maf <- readMaf(mafFile=maf.File, refBuild="hg19")
#' njtree <- getPhyloTree(maf)
#' @return  an object of class PhyloTree
#' @exportClass phyloTree
#' @export getPhyloTree


# set NJtree object
getPhyloTree <- function(maf, 
                      method = "NJ",
                      minVaf=0.02, 
                      maxVaf=1){
  
  maf.dat <- maf@data

  if (max(maf.dat$VAF, na.rm=TRUE) > 1){
    maf.dat$VAF <- maf.dat$VAF/100
  }
  maf.dat <- maf.dat[which(maf.dat$VAF > minVaf & maf.dat$VAF < maxVaf), ]
  ## information input
  patientID <- maf@patientID
  refBuild <- paste("BSgenome.Hsapiens.UCSC.", maf@ref.build, sep = "")
  binary.matrix <- getMutMatrix(maf.dat, use.ccf = FALSE)
  if("CCF" %in% colnames(maf.dat)){
      ccf.matrix <- getMutMatrix(maf.dat, use.ccf = TRUE)
  }else{
      ccf.matrix <- matrix() 
  }
  mut_dat <- t(binary.matrix)
  matTree <- nj(dist.gene(mut_dat))
  if(method == "MP"){
      tree_dat <- phangorn::as.phyDat(mut_dat, type="USER", levels = c(0, 1))
      tree_pars <- phangorn::optim.parsimony(matTree, tree_dat)
      matTree <- phangorn::acctran(tree_pars, tree_dat)
  }
  if(method == "ML"){
      tree_dat <- phangorn::as.phyDat(mut_dat, type="USER", levels = c(0, 1))
      fitJC <- phangorn::pml(matTree, tree_dat)
      fitJC <- phangorn::optim.pml(fitJC)
      matTree <- fitJC$tree
  }
  numRoot <- which(matTree$tip.label == "NORMAL")
  bootstrap.value <- ape::boot.phylo(matTree, t(binary.matrix), function(e) root(nj(dist.gene(e)),numRoot),B = 1000)/1000
  branchAlias <- readPhyloTree(matTree)
  mut.branches <- .treeMutationalBranches(maf.dat, branchAlias, binary.matrix)
  phylo.tree <- new('phyloTree', patientID = patientID, tree = matTree, 
                    binary.matrix = binary.matrix, ccf.matrix = ccf.matrix, 
                    mut.branches = mut.branches, refBuild = maf@ref.build,
                    bootstrap.value = bootstrap.value)
  return(phylo.tree)
}
#Prevent class 'phylo' from not existing
setClass('phylo')
setClass('phyloTree', slots = c(tree = 'phylo', patientID = 'character', binary.matrix = 'matrix', mut.branches = 'list', ccf.matrix = 'matrix', refBuild = 'character',
                                bootstrap.value = 'numeric'))
