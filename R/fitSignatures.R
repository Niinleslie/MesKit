#'  fitSignatures
#' @description Find nonnegative linear combination of mutation signatures to reconstruct matrix and 
#' calculate cosine similarity based on somatic SNVs.
#' 
#' @param tri_matrix A matrix or a list of matrix generated by \code{\link{triMatrix}} function.
#' @param patient.id Select the specific patients. Default: NULL, all patients are included
#' @param signaturesRef Signature reference,Users can upload their own reference. Default "cosmic_v2". Option: "exome_cosmic_v3","nature2013".
#' @param associated Associated Vector of associated signatures. If given, will narrow the signatures reference to only the ones listed.Default NULL.
#' @param min.mut.count The threshold for the variants in a branch. Default 15.
#' @param signature.cutoff Discard any signature contributions with a weight less than this amount.Default: 0.1.
#' @return A list of data frames, each one contains treeMSOutput, containing information about each set/branch's mutational signature.
#' 
#' @importFrom pracma lsqnonneg
#' @examples
#' fitSignatures(tri_matrix)
#' @export  fitSignatures

fitSignatures <- function(tri_matrix = NULL,
                          patient.id = NULL,
                          signaturesRef = "cosmic_v2",
                          associated  = NULL,
                          min.mut.count = 15,
                          signature.cutoff = 0.1){
    
    if(!is.null(patient.id)){
         patient.setdiff <- setdiff(patient.id, names(tri_matrix))
         if(length(patient.setdiff) > 0){
            stop(paste0("Error: patient ", patient.setdiff, " can not be found in your data"))
         }
         tri_matrix <- tri_matrix[names(tri_matrix) %in% patient.id]
    }
  
  ## get signatrue reference
  df.aetiology <- NULL
  if(is(signaturesRef,'character')){
    signaturesRef <- match.arg(signaturesRef,
                               choices = c("cosmic_v2","nature2013","exome_cosmic_v3"),
                               several.ok = FALSE)
    signatures.aetiology <- readRDS(file = system.file("extdata", "signatures.aetiology.rds", package = "MesKit")) 
    if (signaturesRef == "cosmic_v2"){
      sigsRef <- readRDS(file = system.file("extdata", "signatures.cosmic.rds", package = "MesKit"))
      rownames(sigsRef) <- gsub("Signature.", "Signature ", rownames(sigsRef))
      df.aetiology <- data.frame(aeti = signatures.aetiology$cosmic_v2$aetiology,
                                 sig = rownames(signatures.aetiology$cosmic_v2))
    }else if(signaturesRef == "nature2013"){
      sigsRef <- readRDS(file = system.file("extdata", "signatures.nature2013.rds", package = "MesKit"))
      ## rename signature
      rownames(sigsRef) <- gsub("Signature.", "Signature ", rownames(sigsRef))
      df.aetiology <- data.frame(aeti = signatures.aetiology$nature2013$aetiology,
                                 sig = rownames(signatures.aetiology$nature2013))
    }else if(signaturesRef == "exome_cosmic_v3"){
      sigsRef <- readRDS(file = system.file("extdata", "signatures.exome.cosmic.v3.may2019.rds", package = "MesKit"))
      df.aetiology <- data.frame(aeti = signatures.aetiology$cosmic_v3$aetiology,
                                 sig = rownames(signatures.aetiology$cosmic_v3))
    }
  }else if(!is(signaturesRef, 'data.frame')){
    stop('Input signature reference should be a data frame')
  }else{
    sigsRef <- signaturesRef 
  }
  
  if(!is.null(associated)){
    signature.setdiff <- setdiff(associated, rownames(sigsRef))
    if(length(signature.setdiff) > 0){
      stop(paste0(signature.setdiff, " can not be found in signature reference"))
    }
    sigsRef <- sigsRef[rownames(sigsRef) %in% associated, ]
  }
  
  result <- list()
  tri_matrix_list <- tri_matrix
  for(i in seq_len(length(tri_matrix_list))){
    tri_matrix <- tri_matrix_list[[i]]
    patient <- names(tri_matrix_list)[i]
    
    ## Remove branches whose mutation number is less than min.mut.count
    branch_remove <- rownames(tri_matrix[rowSums(tri_matrix) <= min.mut.count,])
    if(length(branch_remove) > 0){
      message("Warning: mutation number of ", paste(branch_remove, collapse = ", ")," in ",patient, " is less than min.mut.count")
      branch_left <- setdiff(rownames(tri_matrix),branch_remove)
      if(length(branch_left) == 0){
        next
      }
      
      tri_matrix <- tri_matrix[branch_left,]
      ## rebuild matrix if there is only one branch left
      if(is(tri_matrix, "numeric")){
        type_name <- names(tri_matrix)
        tri_matrix <- matrix(tri_matrix, ncol = length(tri_matrix))
        rownames(tri_matrix) <- branch_left
        colnames(tri_matrix) <- type_name
      }
    }
    
    ## convert mutation number to proportion
    origin_matrix <- t(apply(tri_matrix,1,function(x)x/sum(x)))
    
    ## calculate cosine similarity
    branch_num <- nrow(origin_matrix)
    refsig_num <- nrow(sigsRef)
    
    cos_sim_matrix <- matrix(nrow = branch_num,ncol = refsig_num)
    rownames(cos_sim_matrix) <- rownames(origin_matrix)
    colnames(cos_sim_matrix) <- rownames(sigsRef)
    
    for(i in seq_len(branch_num)){
      x <- as.numeric(origin_matrix[i,])  
      for( j in seq_len(refsig_num)){
        y <- as.numeric(sigsRef[j,])  
        s <- as.numeric(x %*% y / (sqrt(x %*% x) * sqrt(y %*% y)))
        cos_sim_matrix[i,j] <- s
      }
    }
    
    ## calculate signature contribution by solving nonnegative least-squares constraints problem(weight)
    type_num <- ncol(origin_matrix)
    
    sigsRef_t <- t(as.matrix(sigsRef))
    ## contribution matrix
    con_matrix <- matrix(1, nrow = branch_num, ncol = refsig_num)
    ## reconstruted matrix
    recon_matrix <- matrix(1, nrow = branch_num, ncol = type_num)
    
    ## solve nonnegative least-squares constraints.
    for(i in seq_len(branch_num)){
      m <- as.numeric(origin_matrix[i,]) 
      lsq <- pracma::lsqnonneg(sigsRef_t, m)
      con_matrix[i,] <- lsq$x
      recon_matrix[i,] <- sigsRef_t %*% as.matrix(lsq$x)
    }
    
    rownames(con_matrix) <- rownames(origin_matrix)
    colnames(con_matrix) <- rownames(sigsRef)
    
    rownames(recon_matrix) <- rownames(origin_matrix)
    colnames(recon_matrix) <- colnames(origin_matrix)
    
    ## calculate RSS of reconstructed matrix and origin matrix
    RSS <- c()
    for(i in seq_len(branch_num)){
      r <- recon_matrix[i,]
      o <- origin_matrix[i,]
      rss <- sum((r-o)^2) 
      RSS <- c(RSS,rss)
    }
    names(RSS) <- rownames(origin_matrix)
    
    ## summary mutation signatures of branches
    if(!is.null(df.aetiology)){
      aetiology_ref <- as.character(df.aetiology$aeti)  
      names(aetiology_ref) <-  as.character(df.aetiology$sig)
    }
    aetiology_ref <- as.character(df.aetiology$aeti)  
    names(aetiology_ref) <-  as.character(df.aetiology$sig)
    signatures_aetiology <- data.frame()
    for(i in seq_len(branch_num)){
      branch_name <- rownames(tri_matrix)[i]
      contribution <- con_matrix[i,]
      sig_cut <- names(contribution[contribution > signature.cutoff])
      if(length(sig_cut) == 0){
          next
      }
      sig_con <- as.numeric(contribution[contribution > signature.cutoff])  
      # mut_sum <- sum(tri_matrix[i,])
      
      sub <- data.frame(Branch = branch_name, 
                        Signature = sig_cut,
                        # Mutation_number = mut_sum,
                        Contribution = sig_con)
      if(!is.null(df.aetiology)){
        aet <- aetiology_ref[sig_cut]
        sub$Aetiology <- as.character(aet)  
      }
      signatures_aetiology <- rbind(signatures_aetiology, sub)
    }
    ## order data frame by contribution of each branch
    signatures_aetiology <- dplyr::arrange(signatures_aetiology,
                                           plyr::desc(Branch),
                                           plyr::desc(Contribution))
    
    result[[patient]] <- list(
      reconstructed.mat = recon_matrix,
      original.mat = origin_matrix,
      cosine.similarity = cos_sim_matrix,
      RSS = RSS, 
      signatures.aetiology = signatures_aetiology
    )
    
  }
  
  if(length(result) == 0){
    return(NA)
  }else{
    return(result)
  }
  
}