#' MathScore
#' @description Calculate MATH score and VAF value could be filtered with minvaf and maxvaf.
#' 
#' @param maf The classMaf object generated by readMaf.
#' @param tsb Specify Tumor_Sample_Barcodes for single or all samples from maf of the patient
#' @param minvaf  Filter low frequency variants. Default: 0. Option: on the scale of 0 to 1. 
#' @param maxvaf Filter extremely high frequency variants. Default: 0. Option: on the scale of 0 to 1.
#' @return A list containing MATH scores of all/selected samples.
#' 
#' @examples
#' mathScore(maf, tsb=c("All"), minvaf=0.02, maxvaf=1)
#' mathScore(maf, tsb=c("SRR3670035"))
#' 
#' @export mathScore


## MATH Score main function
mathScore <- function(maf, tsb=c("All"), minvaf=0.02, maxvaf=1){
    ## get vaf-related infomation
    mafData <- maf@data
    dataHugoSymbol <- mafData$Hugo_Symbol
    dataVaf <- mafData$VAF
    dataTsb <- data.frame(mafData$Tumor_Sample_Barcode)
    vafInputMt <- data.frame(dataHugoSymbol, dataVaf, dataTsb)
    colnames(vafInputMt) <- c("Hugo_Symbol", "VAF", "Tumor_Sample_Barcode")
    ## get all sample names
    tsbLs <- data.frame(unique(vafInputMt$Tumor_Sample_Barcode))
    
    ## MATH results for one/all sample
    if (any(tsb == c("All"))){
        ## list all samples' MATH scores
        mathOFA <- .multiSampleMATH(vafInputMt, tsbLs, minvaf, maxvaf)
        colnames(mathOFA) <- c("Tumor_Sample_Barcode", "MATH_score", 
                               "TMB(mutations/Mb)")
        mathOFA <- mathOFA[, c("Tumor_Sample_Barcode", "MATH_score")]
        mathResult <- list(sampleLevel=mathOFA)
        return(mathResult)
    } else{
        ## calculate specific samples' MATH score
        tsbLs <- data.frame(tsb)
        mathSp <- .multiSampleMATH(vafInputMt, tsbLs, minvaf, maxvaf)
        colnames(mathSp) <- c("Tumor_Sample_Barcode", "MATH_score", 
                              "TMB(mutations/Mb)")
        mathSp <- mathSp[, c("Tumor_Sample_Barcode", "MATH_score")]
        mathResult <- list(sampleLevel=mathSp)
        return(mathResult)
    }
    message("MATH Score Calculation Done!")
}


#' getTMB
#' @description Calculate tumor mutational burden(TMB) and VAF value could be filtered with minvaf and maxvaf.
#' 
#' @param maf the classMaf object generated by readMaf.
#' @param tsb specify excute ITH asessment for single or all samples from the same patient(Tumor_Sample_Barcodes) 
#' @param minvaf  Default: 0. Option: on the scale of 0 to 1. Filter low frequency variants.
#' @param maxvaf Default: 0. Option: on the scale of 0 to 1. Filter extremely high frequency variants.
#' @return a list containing MATH scores of all/selected samples.
#' 
#' @examples
#' getTMB(maf, tsb=c("All"), minvaf=0.02, maxvaf=1)
#' getTMB(maf, tsb=c("SRR3670035"))
#' 
#' @export getTMB

## TMB main function (actually could be combined as a lighter tool)
getTMB <- function(maf, tsb=c("All"), minvaf=0.02, maxvaf=1){
    ## get vaf-related infomation
    mafData <- maf@data
    dataHugoSymbol <- mafData$Hugo_Symbol
    dataVaf <- mafData$VAF
    dataTsb <- data.frame(mafData$Tumor_Sample_Barcode)
    vafInputMt <- data.frame(dataHugoSymbol, dataVaf, dataTsb)
    colnames(vafInputMt) <- c("Hugo_Symbol", "VAF", "Tumor_Sample_Barcode")
    ## get all sample names
    tsbLs <- data.frame(unique(vafInputMt$Tumor_Sample_Barcode))
    
    ## TMB results for one/all sample
    if (any(tsb == c("All"))){
        ## list all samples' TMB scores
        mathOFA <- .multiSampleMATH(vafInputMt, tsbLs, minvaf, maxvaf)
        colnames(mathOFA) <- c("Tumor_Sample_Barcode", "MATH_score", 
                               "TMB(mutations/Mb)")
        TMB <- mathOFA[, c("Tumor_Sample_Barcode", "TMB(mutations/Mb)")]
        TMBResult <- list(sampleLevel=TMB)
        return(TMBResult)
    } else{
        ## calculate specific samples' TMB score
        tsbLs <- data.frame(tsb)
        mathSp <- .multiSampleMATH(vafInputMt, tsbLs, minvaf, maxvaf)
        colnames(mathSp) <- c("Tumor_Sample_Barcode", "MATH_score", 
                              "TMB(mutations/Mb)")
        TMB <- mathSp[, c("Tumor_Sample_Barcode", "TMB(mutations/Mb)")]
        TMBResult <- list(sampleLevel=TMB)
        return(TMBResult)
    }
    message("TMB Calculation Done!")
}



## Data cleaning
.dataClean <- function(vafInputMt, tsb, minvaf, maxvaf){
    vafColumnMATH <- vafInputMt[which(
        vafInputMt$Tumor_Sample_Barcode == tsb), ]$VAF
    vafColumnMATH <- vafColumnMATH[which(
        !is.na(vafColumnMATH))][which(
            vafColumnMATH > minvaf & vafColumnMATH < maxvaf)]
    vafColumnMATH <- as.numeric(
        as.character(vafColumnMATH))[which(!is.na(vafColumnMATH))]
    return(vafColumnMATH)
}

## MATH Caculation
.calMATH <- function(vafColumnMATH){
    MAD <- 1.4826*median(abs(vafColumnMATH - median(vafColumnMATH)))
    MATH <- 100 * MAD / median(vafColumnMATH)
    return(round(MATH, digits=3))
}

## Tumor burden Caculation
.calTumorBurden <- function(vafColumnMATH){
    tumorBurden <- length(vafColumnMATH)/40
    return(tumorBurden)
}

## MATH multi-sample process
.multiSampleMATH <- function(vafInputMt, tsbLs, minvaf, maxvaf){
    samplesMATH <- data.frame()
    for (counter in seq_along(tsbLs[,1])){
        for (sampleNameMt in tsbLs){
            vafColumnMATH <- .dataClean(
                vafInputMt, 
                as.character(sampleNameMt)[counter], 
                minvaf, maxvaf)
            sampleMATH <- data.frame(
                as.character(sampleNameMt)[counter], 
                .calMATH(vafColumnMATH), .calTumorBurden(vafColumnMATH))
            samplesMATH <- rbind(samplesMATH, sampleMATH)
        }
    }
    colnames(samplesMATH) <- c("Tumor_Sample_Barcode", "MATH_score", 
                               "Tumor_Burden")
    return(samplesMATH)
}

# ## MATH patient calcualtion
# .patientMATH <- function(vafInputMt, tsbLs, minvaf, maxvaf){
#     vafColumnMATH <- vafInputMt$VAF
#     tsbNum <- nrow(tsbLs)
#     vafColumnMATH <- vafColumnMATH[which(
#         !is.na(vafColumnMATH))][which(
#             vafColumnMATH > minvaf & vafColumnMATH < maxvaf)]
#     vafColumnMATH <- as.numeric(
#         as.character(vafColumnMATH))[which(
#             !is.na(vafColumnMATH))]
#     result <- data.frame(MATH_score=.calMATH(vafColumnMATH), 
#                          Tumor_Burden=length(vafColumnMATH)/40/tsbNum)
#     return(result)
# }
