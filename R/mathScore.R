#' mathScore
#' @description Calculate MATH score and VAF value could be filtered with minvaf and maxvaf.
#' 
#' @param maf a Maf object generated by readMaf.
#' @param tsb specify Tumor_Sample_Barcodes of samples. Default: NULL, which outputs MATH scores of all samples.
#' @param minvaf the minimum VAF for filtering variants. Default: 0.02 Option: on the scale of 0 to 1. 
#' @param maxvaf the maximum VAF for filtering variants. Default: 1. Option: on the scale of 0 to 1.
#' @return A list containing MATH scores of all/selected samples.
#' 
#' @examples
#' mathScore(maf, tsb=NULL, minvaf=0.02, maxvaf=1)
#' mathScore(maf, tsb=c("SRR3670035"))
#' 
#' @export mathScore


## MATH Caculation
calMATH <- function(VAF){
    VAF = VAF[!is.na(VAF)] 

    MAD <- 1.4826*median(abs(VAF - median(VAF)))
    MATH <- 100 * MAD / median(VAF)
    return(round(MATH, digits=3))
}


## MATH Score main function
mathScore <- function(maf, tsb=NULL, minvaf=0.02, maxvaf=1){
    mafData <- maf@data

    if (is.null(tsb)){
        tsb = unique(mafData$Tumor_Sample_Barcode)
    } 

    ## get vaf-related infomation
    MATH.df <- mafData %>%
        dplyr::filter(Tumor_Sample_Barcode %in% tsb) %>%
        dplyr::filter(VAF> minvaf & VAF < maxvaf) %>%
        dplyr::group_by(PatientID, Tumor_Sample_Barcode) %>%
        dplyr::summarise(MATH_Score = calMATH(VAF))

    return(MATH.df)
    message("MATH Score Calculation Done!")
    
}
