#' mathScore
#' @description Calculate MATH score and VAF value could be filtered with minvaf and maxvaf.
#' 
#' @param maf a Maf object generated by readMaf.
#' @param patient.id select the specific patients. Default: NULL, all patients are included
#' @param min.vaf the minimum VAF for filtering variants. Default: 0.02 
#' @return a list containing MATH scores and violin plot of all samples
#' 
#' @examples
#' mathScore(maf, min.vaf=0.02, max.vaf=1)
#' @export mathScore

## MATH Score main function
mathScore <- function(maf, patient.id = NULL, min.vaf=0.02,
                      # plot = TRUE,
                      withinType = FALSE, use.adjVAF = TRUE){

    ## MATH Caculation
    calMATH <- function(VAF){
    VAF = VAF[!is.na(VAF)] 
       
    MAD <- 1.4826*median(abs(VAF - median(VAF)))
    MATH <- 100 * MAD / median(VAF)
    return(round(MATH, digits=3))
    }
    
    mafData <- maf@data
    
    if(min.vaf < 0){
        stop("Error: min.vaf must be greater than 0")
    }

    if(is.null(patient.id)){
        patient.id = unique(mafData$Patient_ID)
    }else{
        patient.setdiff <- setdiff(patient.id, unique(mafData$Patient_ID))
        if(length(patient.setdiff) > 0){
            stop(paste0("Patient ", patient.setdiff, " can not be found in your data"))
        }
    }
    
    if(use.adjVAF){
        if(!"VAF_adj" %in% colnames(mafData)){
            stop("Adjust VAF was not found in maf object.Let use.adjVAF be FALSE")
        }
        else{
            mafData <- mafData %>% 
                dplyr::mutate(VAF = VAF_adj) %>% 
                dplyr::mutate(Type_Average_VAF = Type_Average_VAF_adj)
        }
    }
    
    
    ## get vaf-related infomation
    if(withinType){
        MATH.df <- mafData %>%
            dplyr::filter(Patient_ID %in% patient.id,
                          Clonal_Status == "Subclonal") %>%
            tidyr::unite("mutID",
                         c("Patient_ID",
                           "Tumor_Type",
                           "Chromosome",
                           "Start_Position"
                ),
                sep = ":",
                remove = FALSE
            ) %>% 
            dplyr::filter(Type_Average_VAF > min.vaf) %>%
            dplyr::group_by(Patient_ID, Tumor_Type) %>%
            dplyr::distinct(mutID,.keep_all = TRUE) %>% 
            dplyr::summarise(MATH_Score = calMATH(Type_Average_VAF)) %>%
            dplyr::ungroup() %>%
            dplyr::mutate(Patient_ID = as.factor(Patient_ID)) %>%
            as.data.frame()
    }
    else{
        MATH.df <- mafData %>%
            dplyr::filter(Patient_ID %in% patient.id) %>%
            dplyr::filter(VAF > min.vaf) %>%
            dplyr::group_by(Patient_ID,Tumor_Sample_Barcode) %>%
            dplyr::summarise(MATH_Score = calMATH(VAF)) %>%
            dplyr::ungroup() %>%
            dplyr::mutate(Patient_ID = as.factor(Patient_ID)) %>%
            as.data.frame()
    }

    y.limits <- c(
        floor(min(MATH.df$MATH_Score)-15),
        ceiling(max(MATH.df$MATH_Score)+15)
        #ifelse(max(MATH.df$MATH_Score)+15 >100, 100, max(MATH.df$MATH_Score)+15)
    )
    
    # # violin plot
    # if(plot){
    #     p <- ggplot(MATH.df, aes(x=as.factor(Patient_ID), y=MATH_Score, fill = Patient_ID)) + 
    #         geom_violin() + theme_bw() +     
    #         #ylim(y.limits) + 
    #         theme(legend.title = element_blank(),
    #         legend.text = element_text(size = 11),
    #         legend.key.size = unit(0.4, "cm"),
    #         panel.border = element_blank(), 
    #         panel.grid.major = element_line(linetype = 2, color = "grey"),
    #         panel.grid.minor = element_blank(),
    #         axis.line=element_line(color= "black", size= 1),
    #         axis.line.y = element_blank(),
    #         #axis.line.y = element_line(size=0.5, colour = "black"),
    #         #axis.ticks.y = element_line(size=0.5, colour = "black"),
    #         axis.line.x = element_blank(),
    #         axis.title = element_text(size = 12),
    #         axis.ticks.x = element_blank(),
    #         axis.text.x = element_text(size = 11, color = "black", angle = 90),
    #         axis.text.y = element_text(size = 11, color = "black")) + 
    #         scale_y_continuous(limits = y.limits, expand = c(0,0),
    #             breaks = round(seq(y.limits[1], y.limits[2], length = 5)))+
    #         #scale_y_continuous(breaks = c(y.limits[1], 40, 50, 60, 70, 80, 90, y.limits[2]), 
    #                            #limits = y.limits, labels = c(y.limits[1], 40,50,60,70,80,90,y.limits[2]),
    #                            #expand = c(0,0)) +
    #         scale_x_discrete(limits = levels(MATH.df$Patient_ID)) +
    #         labs(y = "MATH score", x = "") +
    #         annotate("segment", x = 0, xend = 0, y = y.limits[1], yend = y.limits[2], size = 0.6)      
    # }else{
    #     p <- NULL
    # }
    # 
    # return(list(MATH.df = MATH.df, MATH.plot = p))  
    
    return(MATH.df)   
    

    message("Calculation of MATH score is done!")
    
}