#' mathScore
#' @description Calculate MATH score and VAF value could be filtered with minvaf and maxvaf.
#' 
#' @param maf a Maf object generated by readMaf.
#' @param patient.id select the specific patients. Default: NULL, all patients are included
#' @param min.vaf the minimum VAF for filtering variants. Default: 0.02 
#' @param max.vaf the maximum VAF for filtering variants. Default: 1
#' @return a list containing MATH scores and violin plot of all samples
#' 
#' @examples
#' mathScore(maf, minvaf=0.02, maxvaf=1)
#' @export mathScore


## MATH Caculation
calMATH <- function(VAF){
    VAF = VAF[!is.na(VAF)] 

    MAD <- 1.4826*median(abs(VAF - median(VAF)))
    MATH <- 100 * MAD / median(VAF)
    return(round(MATH, digits=3))
}


## MATH Score main function
mathScore <- function(maf, patient.id = NULL, min.vaf=0.02, max.vaf=1){
    mafData <- maf@data

    if(is.null(patient.id)){
        patient.id = unique(mafData$Patient_ID)
    }else{
        patient.setdiff <- setdiff(patient.id, unique(mafData$Patient_ID))
        if(length(patient.setdiff) > 0){
            stop(paste0("Patient ", patient.setdiff, " can not be found in your data"))
        }
    }

    ## get vaf-related infomation
    MATH.df <- mafData %>%
        dplyr::filter(Patient_ID %in% patient.id) %>%
        dplyr::filter(VAF > min.vaf & VAF < max.vaf) %>%
        dplyr::group_by(Patient_ID, Tumor_Sample_Barcode) %>%
        dplyr::summarise(MATH_Score = calMATH(VAF)) %>%
        dplyr::ungroup() %>%
        dplyr::mutate(Patient_ID = as.factor(Patient_ID)) %>%
        as.data.frame()

    y.limits <- c(min(MATH.df$MATH_Score)-15, max(MATH.df$MATH_Score)+15)
    
    # violin plot
    p <- ggplot(MATH.df, aes(x=as.factor(Patient_ID), y=MATH_Score, fill = Patient_ID)) + 
      geom_violin() + theme_bw() +     
      ylim(y.limits) + 
      theme(legend.title = element_blank(),
            legend.text = element_text(size = 12),
            panel.border = element_blank(), 
            panel.grid.major = element_line(linetype = 2, color = "grey"),
            panel.grid.minor = element_blank(),
            axis.line=element_line(color= "black", size= 1),
            axis.title = element_text(size = 16),
            axis.text = element_text(size = 12)) +      
      labs(y = "MATH score", x = "")

    return(list(MATH.df = MATH.df, MATH.plot = p))   

    message("Calculation of MATH score is done!")
    
}