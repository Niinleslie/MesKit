#'  plotMutSigProfiler
#' 
#' @param mutSig.product.list a list of probability of 96 mutation types generated by treeMutSig function.
#' @param patient.id patient.id select the specific patients. Default: NULL, all patients are included.
#' @return a list of mutation signature profile of patients
#' 
#' @examples
#' tree.mutSig <- treeMutSig(phyloTree)
#' plotMutSigProfiler(tree.mutSig$mutSig.product.list)
#' @export  plotMutSigProfiler


plotMutSigProfiler <- function(mutSig.product.list, patient.id = NULL, mode = NULL){
    
   
   if(!is.null(mode)){
       mode.options <- c("Original","Reconstructed","Difference")
       if(!mode %in% mode.options){
           stop("mode can only be either 'NULL','Original','Reconstructed' or 'Difference'") 
       }
   }

   
   if(!is.null(patient.id)){
      patient.setdiff <- setdiff(patient.id, names(mutSig.product.list))
      if(length(patient.setdiff) > 0){
         stop(paste0(patient.setdiff, " can not be found in your data"))
      }
      mutSig.product.list <- mutSig.product.list[names(mutSig.product.list)  %in% patient.id] 
   }
   
   mutSig.product <- plyr::rbind.fill(mutSig.product.list)
   if("Branch" %in% colnames(mutSig.product)){
       mutSig.product <- dplyr::group_by(mutSig.product, Patient_ID, Branch) 
   }else{
       mutSig.product <- dplyr::group_by(mutSig.product, Patient_ID, Branch_Tumor_Type) 
   }
   name <-  paste(as.data.frame(group_keys(mutSig.product))[,1],
                  as.data.frame(group_keys(mutSig.product))[,2] ,sep = "_") 
   plot.list <- mutSig.product %>% 
       dplyr::group_map(~plotMutSigProfiler_branch(., mode = mode), keep = TRUE) %>% 
       rlang::set_names(name)
       
   
   for(i in 1:length(plot.list)){
       if(!class(plot.list[[i]])[1] == "gg"){
           message("Warning: No signature found in ", names(plot.list)[i])
       }
   }
   plot.list <- plot.list[!is.na(plot.list)]
   if(length(plot.list) == 0){
       return(NA)
   }
   return(plot.list)
}
