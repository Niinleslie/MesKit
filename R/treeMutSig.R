#'  treeMutSig
#' @description Figure out the intersection of the variants on different branches 
#' in phyloTree_list or phyloTree object and output the treeMSOutput for further summary and plot functions.
#' 
#' 
#' @param phyloTree PhyloTree object generated by getPhyloTree function.
#' @param min.mut.count The threshold for the variants in a branch. Default 15.
#' @param signaturesRef Signature reference,Users can upload their own reference. Default "cosmic_v2". Option: "genome_cosmic_v3","exome_cosmic_v3","nature2013".
#' @param associated Associated Vector of associated signatures. If given, will narrow the signatures reference to only the ones listed.Default NULL.
#' @param signature.cutoff Discard any signature contributions with a weight less than this amount.Default: 0.1.
#' @param patient.id Select the specific patients. Default: NULL, all patients are included
#' @param withinTumor Exploring signatures within tumor. Default: FALSE.
#' @return A list of data frames, each one contains treeMSOutput, containing information about each set/branch's mutational signature.
#' 
#' @importFrom pracma lsqnonneg
#' @importFrom Biostrings getSeq
#' @examples
#' treeMutSig(phyloTree)
#' @export  treeMutSig


## Mutational Signature function
treeMutSig <- function(phyloTree,
                       min.mut.count=15,
                       signaturesRef="cosmic_v2",
                       associated = NULL, 
                       signature.cutoff = 0.1,
                       withinTumor = FALSE,
                       patient.id = NULL){
    
    

    if(class(phyloTree) == "phyloTree"){
        phyloTree_list <- list(phyloTree)
    }else if(class(phyloTree) == "phyloTreeList"){
        if(!is.null(patient.id)){
            phyloTree_list <- subsetPhyloTreeList(phyloTree,patient.id = patient.id)
        }else{
            phyloTree_list <- phyloTree
        }
    }else{
        stop("Error:phyloTree should be class phyloTree or class phyloTreeList generated by function getPhyloTree")
    }
    
    result <- list()
    for(phyloTree in phyloTree_list){
        patient <- phyloTree@patientID
        treeMSOutput <- doTreeMutSig(phyloTree = phyloTree,
                                     min.mut.count = min.mut.count,
                                     signaturesRef = signaturesRef,
                                     withinTumor = withinTumor,
                                     associated = associated, 
                                     signature.cutoff = signature.cutoff)
        mutSig.summary <- doMutSigSummary(treeMSOutput = treeMSOutput,
                                          withinTumor = withinTumor)
        cos_sim.mat <- treeMSOutput$cos_sim.mat
        mutSig.spectrum <- treeMSOutput$spectrum_df
        result[[patient]] <- list(mutSig.summary = mutSig.summary, cos_sim.mat = cos_sim.mat, mutSig.spectrum =  mutSig.spectrum)
    }
    
    if(length(result) == 0){
        return(NA)
    }else{
        return(result)
    }
}