#' vafCluster
#' @description Generate variant allele frequency(VAF) frequency distribution
#'  curve in different mode.
#'  
#' @param maf  Maf or MafList object generated by readMaf function.
#' @param segCN.file The segment file.
#' @param patient.id Select the specific patients. Default: NULL, all patients are included.
#' @param min.vaf The minimum value of VAF. Default: 0. Option: on the scale of 0 to 1
#' @param max.vaf The maximum value of VAF. Default: 0. Option: on the scale of 0 to 1
#' @param plotOption Character. "compare": prints comparison of VAFs distribution among samples; "combine": prints VAFs distribution of samples all together;
#' @param withinTumor Cluster VAF within tumors in each patients,default is FALSE.
#' @param ... Other options passed to \code{\link{subsetMaf}}
#' 
#' @examples
#' vafCluster(maf, plotOption="compare")
#' vafCluster(maf, plotOption="combine")
#' 
#'
#' @export vafCluster

## Main function for VAF plot
vafCluster <-function(maf,
                      segCN.file = NULL,
                      patient.id = NULL,
                      min.vaf = 0.02,
                      max.vaf = 1,
                      plotOption = "combine",
                      withinTumor = FALSE,
                      ...){
  plotOption <- match.arg(plotOption, choices = c('combine', 'compare'), several.ok = FALSE)
  
  ## check input data
  maf_list <- checkMafInput(maf, patient.id = patient.id)
  
  result <- list()
  for(m in maf_list){
      
      ## remove mutation in CNA regions
      if(!is.null(segCN.file)){
          seg <- readSegment(segCN.file = segCN.file)
          m <- copyNumberFilter(m,seg)
      }
      
      maf_data <- subsetMaf(m,
                            min.vaf = min.vaf,
                            max.vaf = max.vaf,
                            ...)
      patient <- unique(maf_data$Patient_ID) 
      
      ## extract vaf info
      if(withinTumor){
          maf_data$VAF <- maf_data$Tumor_Average_VAF
          maf_data$ID <- maf_data$Tumor_ID
          id_list <- unique(maf_data$ID)
      }else{
          maf_data$ID <- maf_data$Tumor_Sample_Barcode
          id_list <- unique(maf_data$ID)
      }
      ## plot all samples' vaf distribution
      if (plotOption == "combine"){
          ## general data process for all samples 
          plot_list <- list()
          
          for (id in id_list){
              subdata <- maf_data[ID == id]  
              ## data cleaning
              if (nrow(subdata) < 3) {
                  message(paste0("Error: mutations of Sample ", id, " are not enough for clustering"))
                  next()
              }
              
              ## infer possible cluster from maf_data
              message(paste("Processing ", id," of ", patient, sep = ""))
              cluster_result <- mclust::densityMclust(subdata$VAF, G=1:7, verbose=FALSE)
              subdata$cluster <- as.character(cluster_result$classification)
              
              # prepare separated pictures for later combination 
              p  <- drawVAFCombine(subdata)
              if(length(id_list) == 1){
                      p <- p + ggtitle(label = paste("VAF clustering of ", patient, sep=""),
                                       subtitle = id)+
                      theme(plot.title = element_text(face = "bold",size = 18,hjust = 0.5),
                            plot.subtitle = element_text(size = 16,hjust = 1,vjust = -5))
              }
              plot_list[[id]] <- p
          }
          
          ## combine: print VAF pictures for all samples in one document
          pic <- cowplot::plot_grid(plotlist = plot_list,ncol = 2)
          
          combineTitle <-  ggdraw() + draw_label(
              paste("VAF clustering of ", patient, sep=""),
              fontface = 'bold',
              x = 0.5,
              hjust = 0.5,
              size = 17
          )
          pic <- cowplot::plot_grid(combineTitle,
                                    pic,
                                    ncol = 1,
                                    # rel_heights values control vertical title margins
                                     rel_heights = c(0.1, 1))
          result[[patient]] <- pic
          next
              # return(suppressWarnings(suppressMessages(pic)))
      }
      
      ## plot all samples' vaf distribution with ggridges
      else if (plotOption == "compare"){
          all_cluster_result <- c()
          for (id in id_list){
              subdata <- maf_data[ID == id]  
              if (nrow(subdata) < 3) {
                  message(paste0("Error: mutations of Sample ", id, " are not enough for clustering"))
                  maf_data <- maf_data[ID != id]
                  next
              }
              ## generate data from different Tumor_Sample_Barcode
              message(paste("Processing ", id," of ", patient, sep = ""))
              cluster_result <- mclust::densityMclust(subdata$VAF, G=1:7, verbose=FALSE)
              all_cluster_result <- c(all_cluster_result, as.character(cluster_result$classification))
          }
          # print(all_cluster_result)
          maf_data$cluster <- all_cluster_result
          pic <- suppressMessages(drawVAFCompare(maf_data, withinTumor = withinTumor))
          result[[patient]] <- pic
          next
      }
      
  }
  if(length(result) > 1){
      return(result)
  }else if(length(result) == 0){
      return(NA)
  }else{
      return(result[[1]])
  }
  
}