#' @title ccfAUC
#' @description The tumor heterogeneity was estimated as the area under the curve (AUC) of the cumulative density function from all cancer cell fractions per tumor
#' 
#' @references Charoentong P, Finotello F, et al. Pan-cancer Immunogenomic Analyses Reveal Genotype-Immunophenotype Relationships and Predictors of Response to Checkpoint Blockade. Cell reports 2017, 18:248-262. 
#' 
#' @param maf Maf or MafList object generated by \code{\link{readMaf}} function.
#' @param patient.id select the specific patients. Default: NULL, all patients are included
#' @param min.ccf The minimum value of CCF. Default: 0
#' @param withinTumor Calculate AUC within types in each patients,default is FALSE.
#' @param plot.density whether to show the density plot. Default: TRUE
#' @param ... Other options passed to \code{\link{subsetMaf}}
#' 
#' @return A list containing AUC of CCF and a graph
#' 
#' @examples
#' ccfAUC(maf)
#' 
#' @export ccfAUC

ccfAUC <- function(
   maf, 
   patient.id = NULL, 
   min.ccf = 0, 
   withinTumor = FALSE,
   plot.density = TRUE,
   ...
){
    ## check input data
    maf_list <- checkMafInput(maf, patient.id = patient.id)
    
    result <- list()
    for(m in maf_list){
        if(! "CCF" %in% colnames(getMafData(m)) ){
            stop(paste0("Error: calculation of AUC of CCF requires CCF data." ,
                        "No CCF data was found when generate Maf object."))
        }
        maf_data <- subsetMaf(m,
                              min.ccf = min.ccf,...) %>% 
        dplyr::filter(!is.na(CCF))
        if(withinTumor) {
            maf_data <- dplyr::filter(maf_data, !is.na(Tumor_Average_CCF))
        }
        patient <- getMafPatient(m)
        if(nrow(maf_data) == 0){
            message("Warning :there was no mutation in ", patient, " after filter.")
            next
        }
        
        if(plot.density){
            CCF.density.plot <- list()
        }
        AUC.df <- data.frame()
        
        if(withinTumor){
            ids <- unique(maf_data$Tumor_ID)
        }else{
            ids <- unique(maf_data$Tumor_Sample_Barcode)
        }
        CCF.sort <- data.frame()
        for(id in ids){
            if(withinTumor){
                subdata <- subset(maf_data, Tumor_ID == id)
                ccf <- subdata$Tumor_Average_CCF
            }else{
                subdata <- subset(maf_data, Tumor_Sample_Barcode == id)
                ccf <- subdata$CCF
            }
            df_ccf <- data.frame(CCF = as.vector(sort(ccf)), prop = seq_len(length(ccf))/length(ccf))
            auc <- suppressWarnings(stats::integrate(approxfun(df_ccf$CCF,df_ccf$prop),
                                                     min(df_ccf$CCF),
                                                     max(df_ccf$CCF),
                                                     # subdivisions = length(df_ccf),
                                                     stop.on.error = FALSE)$value)
            # auc <- 0
            # for(i in seq_len(nrow(df_ccf)-1)){
            #     mutArea <- (df_ccf[i, "prop"] + df_ccf[i+1, "prop"])*(df_ccf[i+1, "CCF"] - df_ccf[i, "CCF"])/2
            #     auc <- mutArea + auc
            # }
            if(withinTumor){
                a <- data.frame(Patient_ID = patient, Tumor_ID = id, AUC = auc)
            }else{
                a <- data.frame(Patient_ID = patient, Tumor_Sample_Barcode = id, AUC = auc)
            }
            AUC.df <- rbind(AUC.df, a)
            
            if(withinTumor){
                c <-  subdata %>%         
                    dplyr::arrange(Tumor_Average_CCF) %>%
                    dplyr::mutate(prop = seq_len(nrow(.)/nrow(.))) %>% 
                    dplyr::mutate(Tumor_ID = paste0(Tumor_ID," (", round(auc,3), ")"))
                
            }else{
                c <-  subdata %>%         
                    dplyr::arrange(CCF) %>%
                    dplyr::mutate(prop = seq_len(nrow(.)/nrow(.))) %>% 
                    dplyr::mutate(Tumor_Sample_Barcode = paste0(Tumor_Sample_Barcode," (",round(auc,3),")"))
                
            }
            CCF.sort <- rbind(CCF.sort, c)
            
        }
        
        if(plot.density){
            if(withinTumor){
                p <- ggplot2::ggplot(CCF.sort, 
                                     aes(x=Tumor_Average_CCF, y=prop, group=Tumor_ID, color=Tumor_ID))
            }else{
                p <- ggplot2::ggplot(CCF.sort, 
                                     aes(x=CCF, y=prop, group=Tumor_Sample_Barcode, color=Tumor_Sample_Barcode))
            }
            p <- p + 
                #geom_smooth(na.rm = TRUE, se = FALSE, size = 1.2, formula = y ~ s(x, bs = "cs"), method = "gam") +
                theme_bw() + 
                geom_line(size=1.2) +
                xlim(0, 1) + ylim(0, 1) +     
                coord_fixed() +
                theme(
                    #legend.position='none', 
                    legend.title = element_blank(),
                    plot.title =  element_text(size=13.5, face = "bold"), 
                    axis.title = element_text(size=13),
                    panel.grid=element_blank(), 
                    panel.border=element_blank(), 
                    axis.line=element_line(size=0.7, colour = "black"),
                    axis.text = element_text(size=11, colour = "black"),
                    legend.text = element_text(size=11, colour = "black"),
                    panel.grid.major = element_line(linetype = 2, color = "grey")
                )+
                labs(x = "CCF", y = "Proportion", 
                     title = paste0("AUC plot of CCF : ", patient))
            
            CCF.density.plot <- p
            result[[patient]] <- list(AUC.value = AUC.df, CCF.density.plot = CCF.density.plot)
            next
        }else{
            result[[patient]] <- AUC.df
        }
    }
    
    if(length(result) > 1){
        return(result)
    }else if(length(result) == 0){
        return(NA)
    }else{
        return(result[[1]])
    }
    return(result)
   
}


# if(plot) {
#   CCF.plot <- ggplot(AUC.df, aes(x=as.factor(Patient_ID), y=AUC, fill = Patient_ID)) + 
#     geom_violin() + theme_bw() +     
#     #ylim(0,1) + 
#     theme(legend.title = element_blank(),
#           legend.text = element_text(size = 12),
#           panel.border = element_blank(), 
#           panel.grid.major = element_line(linetype = 2, color = "grey"),
#           panel.grid.minor = element_blank(),
#           axis.line=element_line(color= "black", size= 1),
#           axis.line.y = element_blank(),
#           axis.line.x = element_blank(),
#           axis.title = element_text(size = 12),
#           axis.ticks.x = element_blank(),
#           axis.text.x = element_text(size = 11, color = "black", angle = 90),
#           axis.text.y = element_text(size = 11, color = "black")) +     
#     scale_y_continuous(breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1.0), 
#                        limits = c(0,1), 
#                        expand = c(0,0)) +
#     scale_x_discrete(limits = levels(AUC.df$Patient_ID)) +
#     labs(y = "AUC of ccf", x = "") + annotate("segment", x = 0, xend = 0, y = 0, yend = 1, size = 0.5)        
#   
# }else{
#   CCF.plot <- NULL
# }