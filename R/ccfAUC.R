#' @title ccfAUC
#' @description The tumor heterogeneity was estimated as the area under the curve (AUC) of the cumulative density 
#' function from all cancer cell fractions per tumor
#' @param maf an Maf object generated by readMaf function.
#' @param tsb specify Tumor_Sample_Barcodes for single or all samples from maf of the patient. Default: NULL, which means that output all samples' AUC Score.
#' @return A list containing AUC scores' data frame and corresponding ccf/proporation plot.
#' 
#' @examples
#' ccfAUC(maf, tsb=NULL)
#' ccfAUC(maf, tsb=c("SRR3670035"))
#' 
#' @export ccfAUC


ccfAUC <- function(maf, tsb = NULL){
    mafData <- maf@data
    
    df.AUC <- data.frame(matrix(ncol=3, nrow=0), stringsAsFactors = FALSE)
    colnames(df.AUC) <- c("Tumor_SampleBarcode", "AUC")
    #colnames(df.AUC) <- c("Tumor_SampleBarcode", "AUC", "Heterogeneity")
    mutCCF.sort.all <- data.frame(matrix(ncol=3, nrow=0), stringsAsFactors = FALSE)
    colnames(mutCCF.sort.all) <- c("Tumor_Sample_Barcode", "ccf", "prop")
    
    ## specify sample.id
    if (is.null(tsb)) {
        tsb <- unique(mafData$Tumor_Sample_Barcode)
    }
    
    ## calculate AUC
    for (sample.id in tsb) {
        mutCCF <- dplyr::filter(
            mafData, Tumor_Sample_Barcode==sample.id
            ) %>%
            dplyr::select(CCF) %>%
            dplyr::filter(!is.na(CCF))
        
        ## calculate each sample's AUC value    
        mutCCF.sort <- data.frame(ccf=as.vector(sort(mutCCF$CCF)), prop=c(1:nrow(mutCCF))/nrow(mutCCF))
        area <- 0
        for (i in (1:(nrow(mutCCF)-1))){
            mutArea <- (mutCCF.sort[i,2] + mutCCF.sort[i+1, 2])*(mutCCF.sort[i+1, 1]-mutCCF.sort[i, 1])/2
            area <- mutArea + area
        }

        ## Heterogeneous or Homogeneous
        ## if (area > 0.145) {
            ## Heterogeneity <- "Heterogeneous"
            ## sample.id <- paste(sample.id, "*", sep="")
        ## } else {
            ## Heterogeneity <- "Homogeneous"
        ## }
        
        ## generate elements for mutCCF.sort.all and df.AUC
        row.mutCCF.sort <- cbind(Tumor_Sample_Barcode=rep(sample.id, nrow(mutCCF.sort)), mutCCF.sort)
        mutCCF.sort.all <- rbind(mutCCF.sort.all, row.mutCCF.sort)
        row.AUC <- data.frame(Tumor_Sample_Barcode=sample.id, AUC=area)
        #row.AUC <- data.frame(Tumor_Sample_Barcode=sample.id, AUC=area, Heterogeneity=Heterogeneity)
        df.AUC <- rbind(df.AUC, row.AUC)
    }

    ## visualise the mutCCF.sort.all data
    p<- ggplot2::ggplot(mutCCF.sort.all, aes(x=ccf, y=prop, group=Tumor_Sample_Barcode, color=Tumor_Sample_Barcode))+ 
        theme_bw()+ 
        geom_line(size=0.8)+
        theme(
            #legend.position='none', 
            title=element_text(size=11, face = "bold"), 
            text=element_text(size=11, face = "bold"), 
            panel.grid=element_blank(), 
            panel.border=element_blank(), 
            axis.line=element_line(size=0.3),
            legend.title=element_text(size=12, face = "bold"),
            legend.text = element_text(size=10, face = "bold")
        )+
        labs(x="CCF", y="Proportion")
#        ggsci::scale_color_npg()+
#        ggsci::scale_fill_npg()
        
    ## result 
    output <- list(AUC.value = df.AUC, AUC.plot=p)
    return(output)
}
