#' @title ccfAUC
#' @description The tumor heterogeneity was estimated as the area under the curve (AUC) of the cumulative density 
#' function from all cancer cell fractions per tumor
#' @param maf an Maf object generated by readMaf function.
#' @param patient.id select the specific patients. Default: NULL, all patients are included
#' @param min.ccf the minimum value of CCF. Default: 0
#' @return A list containing AUC of CCF and a violin plot
#' 
#' @examples
#' ccfAUC(maf)
#' ccfAUC(maf, patient.id = "HCC4064")
#' 
#' @export ccfAUC


ccfAUC.sample <- function(ccf){
    ccf.sort <- data.frame(CCF = as.vector(sort(ccf)), prop = c(1:length(ccf))/length(ccf))
    
    area <- 0
    for(i in 1:(nrow(ccf.sort)-1)){
        mutArea <- (ccf.sort[i, "prop"] + ccf.sort[i+1, "prop"])*(ccf.sort[i+1, "CCF"] - ccf.sort[i, "CCF"])/2
        area <- mutArea + area
    }
    return(area)
}

sortCCF <- function(df){
    CCF.sort <- df %>%
        dplyr::arrange(CCF) %>%
        dplyr::mutate(prop = c(1:nrow(.)/nrow(.)))
}

plotDensity <- function(df){
    CCF.sort <- df %>%
        dplyr::select(Patient_ID, Tumor_Sample_Barcode, CCF) %>%
        dplyr::group_by(Tumor_Sample_Barcode) %>%
        dplyr::group_map(~sortCCF(.x), keep = TRUE) %>%
        do.call("rbind",.)%>%
        as.data.frame()

    p <- ggplot2::ggplot(CCF.sort, 
                         aes(x=CCF, y=prop, group=Tumor_Sample_Barcode, color=Tumor_Sample_Barcode)) + 
      theme_bw() + 
      geom_smooth(se = FALSE,
                  method="gam",
                  formula=y~s(x, bs= "cs"),
                  size = 1.2,
                  na.rm = TRUE) +
      xlim(0,1) + ylim(0,1) +
      coord_fixed() + 
      theme(
        #legend.position='none', 
        legend.title = element_blank(),
        title=element_text(size=14, face = "bold"), 
        text=element_text(size=12, face = "bold"), 
        panel.grid=element_blank(), 
        panel.border=element_blank(), 
        axis.ticks.length = unit(0.3, "cm"),
        axis.ticks = element_line(size=1),
        axis.text = element_text(size=12),
        axis.title = element_text(size=14),
        #legend.title=element_text(size=12, face = "bold"),
        legend.text = element_text(size=12, face = "bold")
      ) +
      geom_segment(x = 0, y = -0.05, xend = 1.0, yend = -0.05, size = 1, 
                   colour = "black", linejoin = "round", lineend = "round") +
      geom_segment(x = -0.05, y = 0, xend = -0.05, yend = 1.0, size = 1, 
                   colour = "black", linejoin = "round", lineend = "round") +
      labs(x="CCF", y="Proportion")
    
    return(p)
    
    
}

ccfAUC <- function(maf, patient.id = NULL, min.ccf = 0, plot.density = TRUE){
    mafData <- maf@data

    if(! "CCF" %in% colnames(mafData)){
        stop(paste0("Error: calculation of AUC of CCF requires CCF data." ,
            "No CCF data was found when generate Maf object."))
    }

    if(is.null(patient.id)){
        patient.id = unique(mafData$Patient_ID)
    }else{
        patient.setdiff <- setdiff(patient.id, unique(mafData$Patient_ID))
        if(length(patient.setdiff) > 0){
            stop(paste0("Patient ", patient.setdiff, " can not be found in your data"))
        }
    }

    mafData <- mafData %>%
        dplyr::filter(Patient_ID %in% patient.id & CCF > min.ccf)

    AUC.df <- mafData %>%
        dplyr::group_by(Patient_ID, Tumor_Sample_Barcode) %>%
        dplyr::summarise(AUC = ccfAUC.sample(CCF)) %>%
        as.data.frame()

    # violin plot of AUC
    if(plot.density){
        density.plot <- mafData %>%
        dplyr::group_by(Patient_ID) %>%
        dplyr::group_map(~plotDensity(.x), keep = TRUE) %>%
        rlang::set_names(patient.id)      
    }else{
        density.plot = NULL
    }


    return(list(AUC.value = AUC.df, CCF.density.plot = density.plot))
    message("Calculation of AUC of CCF is done!")       
        
}
