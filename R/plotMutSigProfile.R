#'  plotMutSigProfile
#' 
#' @param mutSig.spectrum a list of probability of 96 mutation types generated by treeMutSig function.
#' @param patient.id patient.id select the specific patients. Default: NULL, all patients are included.
#' 
#' @return a list of mutation signature profile of patients
#' 
#' @examples
#' tree.mutSig <- treeMutSig(phyloTree)
#' plotMutSigProfile(tree.mutSig$mutSig.spectrum)
#' @export  plotMutSigProfile


plotMutSigProfile <- function(mutSig.spectrum, patient.id = NULL, mode = NULL){
   
   if(!is.null(mode)){
       mode.options <- c("Original","Reconstructed","Difference")
       if(!mode %in% mode.options){
           stop("mode can only be either 'NULL','Original','Reconstructed' or 'Difference'") 
       }
   }

   
   if(!is.null(patient.id)){
      patient.setdiff <- setdiff(patient.id, names(mutSig.spectrum))
      if(length(patient.setdiff) > 0){
         stop(paste0(patient.setdiff, " can not be found in your data"))
      }
      mutSig.spectrum <- mutSig.spectrum[names(mutSig.spectrum)  %in% patient.id] 
   }
   
   mutSig.spectrum <- plyr::rbind.fill(mutSig.spectrum)
   if("Branch" %in% colnames(mutSig.spectrum)){
       mutSig.spectrum <- dplyr::group_by(mutSig.spectrum, Patient_ID, Branch) 
   }else{
       mutSig.spectrum <- dplyr::group_by(mutSig.spectrum, Patient_ID, Branch_Tumor_ID) 
   }
   name <-  paste(as.data.frame(group_keys(mutSig.spectrum))[,1],
                  as.data.frame(group_keys(mutSig.spectrum))[,2] ,sep = "_") 
   plot.list <- mutSig.spectrum %>% 
       dplyr::group_map(~plotMutSigProfile_branch(., mode = mode), keep = TRUE) %>% 
       rlang::set_names(name)
       
   
   for(i in 1:length(plot.list)){
       if(!class(plot.list[[i]])[1] == "gg"){
           message("Warning: No signature found in ", names(plot.list)[i])
       }
   }
   plot.list <- plot.list[!is.na(plot.list)]
   if(length(plot.list) == 0){
       return(NA)
   }
   return(plot.list)
}
