#'  plotMutSigProfile
#' 
#' @param treeMutSig_output object generated by treeMutSig function.
#' @param patient.id patient.id select the specific patients. Default: NULL, all patients are included.
#' @param mode type of mutation spectrum.Default: NULL. Options:'Original','Reconstructed' or 'Difference'
#' 
#' @return a list of mutation signature profile of patients
#' 
#' @examples
#' treeMutSig_output <- treeMutSig(phyloTree)
#' plotMutSigProfile(treeMutSig_output)
#' @export  plotMutSigProfile


plotMutSigProfile <- function(treeMutSig_output, patient.id = NULL, mode = NULL){
   
   if(!is.null(mode)){
       mode.options <- c("Original","Reconstructed","Difference")
       if(!mode %in% mode.options){
           stop("mode can only be either 'NULL','Original','Reconstructed' or 'Difference'") 
       }
   }

   if(!is.null(patient.id)){
       patient.setdiff <- setdiff(patient.id, names(treeMutSig_output))
       if(length(patient.setdiff) > 0){
           stop(paste0(patient.setdiff, " can not be found in your data"))
       }
       treeMutSig_output <- treeMutSig_output[names(treeMutSig_output)  %in% patient.id] 
   }
    
   result <- list()
   for(tms in treeMutSig_output){
       mutSig.spectrum <- tms$mutSig.spectrum
       patient <- unique(mutSig.spectrum$Patient_ID)
       if("Branch" %in% colnames(mutSig.spectrum)){
           mutSig.spectrum <- dplyr::group_by(mutSig.spectrum, Branch) 
       }else{
           mutSig.spectrum <- dplyr::group_by(mutSig.spectrum, Branch_Tumor_ID) 
       }
       name <-  paste(patient,
                      as.data.frame(group_keys(mutSig.spectrum))[,1] ,sep = "_")
       plot_list <- mutSig.spectrum %>% 
           dplyr::group_map(~plotMutSigProfile_branch(., mode = mode), keep = TRUE) %>% 
           rlang::set_names(name)
       plot_list <- plot_list[!is.na(plot_list)]
       result <- append(result,plot_list)
   }
   if(length(result) == 1){
       return(result[[1]])
   }else if(length(result) == 0){
       return(NA)
   }else{
       return(result)
   }
}
