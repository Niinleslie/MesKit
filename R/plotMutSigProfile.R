#'  plotMutSigProfile
#' 
#' @param fit_out result generated by fitSignatures function.
#' @param patient.id patient.id select the specific patients. Default: NULL, all patients are included.
#' @param mode type of mutation spectrum.Default: NULL. Options:'Original','Reconstructed' or 'Difference'
#' 
#' @return mutation signature profile of patients
#' 
#' @examples
#' tri_matrix <- triMatrix(phyloTree)
#' fit_out <- fitSignatrues(tri_matrix)
#' plotMutSigProfile(fit_out)
#' @export  plotMutSigProfile


plotMutSigProfile <- function(fit_out, patient.id = NULL, mode = NULL){
   
   if(!is.null(mode)){
       mode.options <- c("Original","Reconstructed","Difference")
       if(!mode %in% mode.options){
           stop("Error:mode can only be either 'NULL','Original','Reconstructed' or 'Difference'") 
       }
   }

   if(!is.null(patient.id)){
       patient.setdiff <- setdiff(patient.id, names(fit_out))
       if(length(patient.setdiff) > 0){
           stop(paste0(patient.setdiff, " can not be found in your data"))
       }
       fit_out <- fit_out[names(fit_out)  %in% patient.id] 
   }
    
   result <- list()
   for(i in 1:length(fit_out)){
       fit <- fit_out[[i]]
       patient <- names(fit_out)[[i]]
       RSS <- fit$RSS
       signatures_aetiology <- fit$signatures.aetiology
       
       ## convert reconstructed matrix to data frame
       recon_df  <- as.data.frame(fit$reconstructed.mat) 
       recon_df$Branch <- as.character(row.names(recon_df)) 
       rownames(recon_df) <- NULL
       recon_spectrum <- tidyr::pivot_longer(recon_df,
                                             -Branch,
                                             names_to = "Type",
                                             values_to = "Proportion") %>%
           dplyr::mutate(spectrum_type = "Reconstructed")
       ## convert origin matrix to data frame
       origin_df  <- as.data.frame(fit$original.mat) 
       origin_df$Branch <- as.character(row.names(origin_df)) 
       rownames(origin_df) <- NULL
       origin_spectrum <- tidyr::pivot_longer(origin_df,
                                              -Branch,
                                              names_to = "Type",
                                              values_to = "Proportion") %>%
           dplyr::mutate(spectrum_type = "Original")
       
       ## diff proportion = reconstructed proportion - original proportion
       diff_spectrum <- origin_spectrum
       diff_spectrum$Proportion <- recon_spectrum$Proportion - diff_spectrum$Proportion
       diff_spectrum$spectrum_type <- "Difference" 
       
       mut_spectrum <- plyr::rbind.fill(recon_spectrum, origin_spectrum, diff_spectrum) %>% 
           dplyr::rowwise() %>% 
           dplyr::mutate(Group = paste(
               strsplit(Type,"")[[1]][3:5],
               collapse = ''
           )) %>% as.data.frame()
       
       ## set levels
       type_level <- unique(mut_spectrum$Type)
       group_level <- c("C>A", "C>G", "C>T", "T>A", "T>C", "T>G")
       mut_spectrum$Type <- factor(mut_spectrum$Type, levels = type_level)
       mut_spectrum$Group <- factor(mut_spectrum$Group, levels = group_level)
       
       branch_list <- unique(mut_spectrum$Branch)
       for(branch in branch_list){
           branch_spectrum <- subset(mut_spectrum, Branch == branch)
           ## group of background color
           branch_spectrum$group_background <- paste(branch_spectrum$Group,1,sep = "")
           odata <- subset(branch_spectrum, spectrum_type == "Original")
           rdata <- subset(branch_spectrum, spectrum_type == "Reconstructed")
           ddata <- subset(branch_spectrum, spectrum_type == "Difference")
           
           ## calculate cosine similarity between original and reconstructed
           p1 <- odata$Proportion
           p2 <- rdata$Proportion
           cos_sim <- round(sum(p1*p2)/(sqrt(sum(p1^2))*sqrt(sum(p2^2))),3)
           
           ## select specific mode
           if(is.null(mode)){
               branch_spectrum$spectrum_type <- factor(branch_spectrum$spectrum_type,
                                                    levels = c("Original","Reconstructed","Difference"))
               branch_spectrum <- dplyr::arrange(branch_spectrum, spectrum_type)
           }else{
               branch_spectrum <- subset(branch_spectrum, spectrum_type %in% mode)
               branch_spectrum$spectrum_type <- factor(branch_spectrum$spectrum_type,
                                                    levels = unique(branch_spectrum$spectrum_type)) 
           }
           
           ## get signature title
           sig_names <- unique(signatures_aetiology[signatures_aetiology$Branch == branch,]$Signature)
           sig_title <- ''
           for(i in 1:length(sig_names)){
               if(i == 1){
                   sig_title <- sig_names[i]
               }else{
                   sig_title <- paste0(sig_title, " & ", sig_names[i])
               }
           }
           
           ## set color
           group_color <- c("#E64B35FF", "#4DBBD5FF", "#00A087FF",
                             "#3C5488FF", "#F39B7FFF", "#8491B4FF")
           names(group_color) <- group_level
           background_color <- rep(c("#fce7e4","#ecf8fa","#dbfff9",
                                      "#e4e8f3","#fdefeb","#e5e8ef"))
           names(background_color) <- paste(group_level,1,sep = "")
           all_color <- c(group_color,background_color)
           
           # if(!is.null(mode)){
           #     branch_spectrum <- branch_spectrum[branch_spectrum$spectrum_type == mode, ]
           # }
           name <- paste0(patient,": ",branch)
           
           pic <- ggplot(branch_spectrum, aes(x=Type, y=Proportion, group=Group, fill=Group))
           if("Original" %in% branch_spectrum$spectrum_type){
               pic <- pic + geom_rect(data = odata,
                                      aes(fill = group_background),
                                      xmin = -Inf,
                                      xmax = Inf,
                                      ymin = min(odata$Proportion),
                                      ymax = max(odata$Proportion))
           }
           if("Reconstructed" %in% branch_spectrum$spectrum_type){
               pic <- pic + geom_rect(data = rdata,
                                      aes(fill = group_background),
                                      xmin = -Inf,
                                      xmax = Inf,
                                      ymin = min(rdata$Proportion),
                                      ymax = max(rdata$Proportion))
           }
           if("Difference" %in% branch_spectrum$spectrum_type){
               pic <- pic + geom_rect(data = ddata,
                                      aes(fill = group_background),
                                      xmin = -Inf,
                                      xmax = Inf,
                                      ymin = min(ddata$Proportion),
                                      ymax = max(ddata$Proportion))
           }
           pic <- pic + 
               geom_bar(stat="identity") +
               # geom_hline(yintercept = 0)+
               theme(
                   legend.position='none', 
                   strip.background = element_rect(colour = "black", fill = "grey"),
                   strip.text.x=element_text(size=14),
                   strip.text.y=element_text(size=14),
                   panel.spacing.y = unit(0.5, "lines"),
                   panel.spacing.x = unit(0, "lines"),
                   plot.title = element_text(size = 13, hjust = 0,vjust = 0),
                   axis.text.x= element_text(angle = 90,vjust = 0.2,size = 5,colour = "black"),
                   axis.ticks.x=element_line(color = "black"),
                   axis.ticks.length.y = unit(0.2, "cm"),
                   axis.text.y=element_text(size=6, color = "black"))+
               facet_grid(factor(spectrum_type)  ~ Group,scales =  "free") + 
               ## color setting
               scale_fill_manual(values= all_color) +
               scale_y_continuous(expand = c(0,0)) + 
               xlab("Mutational type") + 
               ylab("Mutation probability") + 
               ggtitle(paste(name,"\n",
                             "RSS = ", as.character(round(RSS[branch],3) ),
                             "; Cosine similarity = ", round(cos_sim,3),"\n",
                             sig_title,
                             sep = ""))
           n <- paste0(patient,"_",branch)
           result[[n]] <- pic
       }
       
   }
   if(length(result) == 1){
       return(result[[1]])
   }else if(length(result) == 0){
       return(NA)
   }else{
       return(result)
   }
}
