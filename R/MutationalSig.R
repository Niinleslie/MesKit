#'  treeMutSig
#' @description Figure out the intersection of the variants on different branches 
#' in phyloTree object and output the treeMSOutput for further summary and plot functions.
#' 
#' 
#' @param phyloTree a phyloTree object generated by phyloTree function.
#' @param driverGenesFile The file with driver gene list. Default NULL.
#' @param min.mut.num the threshold for the variants in a branch. Default 15.
#' @param signaturesRef The parameter used for deconstructSig. Default "cosmic". Option: "nature2013". 
#' 
#' @return a list of data frames, each one contains treeMSOutput, containing information about each set/branch's mutational signature.
#' 
#' @examples
#' treeMSOutput <- treeMutSig(phyloTree, driverGenesFile=NULL, min.mut.num=15, signaturesRef="cosmic")
#' @import reshape2 dplyr
#' @export  treeMutSig


## Mutational Signature function
 treeMutSig <- function(phyloTree, driverGenesFile=NULL, min.mut.num=15, signaturesRef="cosmic"){
     treeMS.list <- lapply(phyloTree, doTreeMutSig,
                           driverGenesFile = driverGenesFile,
                           min.mut.num = min.mut.num,
                           signaturesRef = signaturesRef)
     return(treeMS.list)
}

doTreeMutSig <- function(phyloTree,
                         driverGenesFile=NULL,
                         min.mut.num=15,
                         signaturesRef="cosmic"){
    ## refBuild limitation: only hg19 or hg38
    refBuild <- phyloTree@refBuild
    if (!((refBuild == "hg19") | (refBuild == "hg38"))){
        stop(error="Error: refBuild's value may be incorrect. 
             refBuild could be only set as \"hg19\" or \"hg38\".")
    } else {
        refBuild <- paste("BSgenome.Hsapiens.UCSC.", refBuild, sep = "")
    }
    
    ## get branches information from phyloTree object
    mutBranches <- phyloTree@mut.branches
    patientID <- phyloTree@patientID
    branchesName <- names(mutBranches)
    branchesNameList <- strsplit(branchesName, split='∩')
    
    ## regain the data frame of all branches with Sample
    mutSigRef <- data.frame()
    for (branchName in branchesName){
        mutBranch <- mutBranches[[branchName]]
        mutSigRef <- rbind(mutBranch, mutSigRef)
    }
    colnames(mutSigRef) <- c("Sample",  "chr", "pos", "pos_end", 
                             "ref", "alt", "Hugo_Symbol", "mut_id", 
                             "alias")
    ## get the mutational signature of the branch 
    mutSigsOutput <- data.frame()
    lsPicName <- c()
    ## deconstructSigs
    sigsInput <- suppressWarnings(
        deconstructSigs::mut.to.sigs.input(mut.ref=mutSigRef, 
                                           sample.id="Sample", 
                                           chr="chr", 
                                           pos="pos", 
                                           ref="ref", 
                                           alt="alt",
                                           bsg=get(refBuild)))
    for (branchCounter in length(branchesNameList):1){
        ## generate a single branch
        branch <- Filter(Negate(is.na), 
                         branchesNameList[[branchCounter]])
        branchName <- branchesName[branchCounter]
        ## get the mutational signature of the branch
        if (length(mutSigRef[which(
            mutSigRef$Sample == branchName), 1]) < min.mut.num){
            sigsMaxName <- "No Signature"
            sigsMaxProb <- 0
            message(paste("Branch ", branchName,
                          ": Number of mutations is less than min.mut.num.",
                          sep = ""))
            if (any(mutSigRef[which(mutSigRef$Sample == branchName), ]$mut_id == "NoSigTag")) {
                mut.num <- 0
            }
            else{
                mut.num <- length(mutSigRef[which(mutSigRef$Sample == branchName), 1])
            }
        }else{
            if (signaturesRef == "cosmic") {
                sigsWhich <- deconstructSigs::whichSignatures(tumor.ref=sigsInput, 
                                                              signatures.ref=deconstructSigs::signatures.cosmic, 
                                                              sample.id=branchName,
                                                              contexts.needed=TRUE)
            } else if (signaturesRef == "nature2013") {
                sigsWhich <- deconstructSigs::whichSignatures(tumor.ref=sigsInput, 
                                                              signatures.ref=deconstructSigs::signatures.nature2013, 
                                                              sample.id=branchName,
                                                              contexts.needed=TRUE)
            }
            
            
            ## get mutational signature with max weight
            sigsMax <- sigsWhich[["weights"]][which.max(sigsWhich[["weights"]])]
            sigsMaxName <- colnames(sigsMax)
            sigsMaxName <- gsub('[.]', ' ', sigsMaxName)
            sigsMaxProb <- sigsMax[,1]
            
            mut.num <- length(mutSigRef[which(mutSigRef$Sample == branchName), 1])
        }
        
        ## vectorize branch name
        # branch <- gsub(paste(patientID,"-",sep=""), "", branch)
        
        mutSigsBranch <- data.frame(
            branch=c(branchName), 
            alias=as.character(unique(mutSigRef[which(mutSigRef$Sample == branchName), ]$alias)), 
            sig=sigsMaxName, 
            mut.num=mut.num, 
            sig.prob=format(round(sigsMaxProb, digits = 3), nsmall = 3))
        
        ## figure out putative driver genes
        if (!is.null(driverGenesFile)){
            ## read putative driver genes' list
            driverGenes <- as.character(read.table(
                driverGenesFile, header = TRUE, quote="", sep="\n")[,1])
            ## filter potative driver genes of each branch
            pdgMut <- mutSigRef[which(
                mutSigRef$Sample == branchName &
                    as.character(mutSigRef$Hugo_Symbol) %in% driverGenes),]
            pdgBranch <- as.character(pdgMut$Hugo_Symbol)
            ## collect branches' mutataional signature and potative driver genes
            mutSigsBranch <- cbind(mutSigsBranch, putative_driver_genes=c(paste(pdgBranch, collapse = ",")))
        }
        
        
        ## collect branches' mutataional signature information
        mutSigsOutput <- rbind(mutSigsOutput, mutSigsBranch)
    }
    
    
    ## calculation process(maybe could be replaced by lapply)
    if (signaturesRef =="cosmic") {
        ## Aetiology from https://cancer.sanger.ac.uk/cosmic/signatures_v2 emm actually the additional feature may matter
        df.aetiology <- data.frame(
            aeti=c(
                "An endogenous mutational process initiated by spontaneous deamination of 5-methylcytosine",
                "Activity of the AID/APOBEC family of cytidine deaminases", 
                "Failure of DNA double-strand break-repair by homologous recombination",
                "Tobacco mutagens", 
                "Unknown", 
                "Defective DNA mismatch repair and is found in microsatellite unstable tumours",
                "Ultraviolet light exposure", 
                "Unknown", 
                "Polymerase η, which is implicated with the activity of AID during somatic hypermutation", 
                "Recurrent POLE somatic mutations, viz., Pro286Arg and Val411Leu.",
                "Treatments with the alkylating agent temozolomide", 
                "Unknown", 
                "Activity of the AID/APOBEC family of cytidine deaminases(C > U)",
                "Unknown", 
                "Defective DNA mismatch repair", 
                "Unknown", 
                "Unknown",
                "Unknown", 
                "Unknown", 
                "Defective DNA mismatch repair", 
                "Unknown",
                "Exposures to aristolochic acid", 
                "Unknown", 
                "Exposures to aflatoxin",
                "Unknown", 
                "Defective DNA mismatch repair", 
                "Unknown", 
                "Unknown",
                "Tobacco chewing habit", 
                "Unknown", 
                "Unknown"), 
            sig=c("Signature 1", "Signature 2", "Signature 3", "Signature 4", "Signature 5", "Signature 6",
                  "Signature 7", "Signature 8", "Signature 9", "Signature 10", "Signature 11", "Signature 12", 
                  "Signature 13", "Signature 14", "Signature 15", "Signature 16", "Signature 17", "Signature 18",
                  "Signature 19", "Signature 20", "Signature 21", "Signature 22", "Signature 23", "Signature 24", 
                  "Signature 25", "Signature 26", "Signature 27", "Signature 28", "Signature 29", "Signature 30", 
                  "No Signature")
        )
    } else if (signaturesRef =="nature2013") {
        ## Aetiology from https://www.nature.com/articles/nature12477#s1
        df.aetiology <- data.frame(
            aeti=c(
                "Deamination of 5-methyl-cytosine",
                "Deamination of 5-methyl-cytosine", 
                "AID/APOBEC family of cytidine deaminases",
                "Defective homologous-recombination-based DNA double-strand break repair", 
                "Tobacco carcinogens", 
                "Smoking history, C>T and T>C mutations",
                "Defective DNA mismatch repair", 
                "Ultraviolet-light-induced mutations",
                "Exogenous carcinogens, transcription-coupled nucleotide excision repair acting on bulky DNA adducts", 
                "Polymerase η, which is implicated with the activity of AID during somatic hypermutation",
                "Polymerase ε, altered activity of the error-prone polymerase Pol ε", 
                "Alkylating agent temozolomide", 
                "Exogenous carcinogens, transcription-coupled nucleotide excision repair acting on bulky DNA adducts",
                "AID/APOBEC family of cytidine deaminases", 
                "Uncharacterized defects in DNA maintenance", 
                "Uncharacterized defects in DNA maintenance", 
                "Exogenous carcinogens, transcription-coupled nucleotide excision repair acting on bulky DNA adducts",
                "Unknown", 
                "Unknown", 
                "Unknown",
                "Unknown",
                "Uncharacterized defects in DNA maintenance", 
                "Unknown",
                "Unknown",
                "Unknown", 
                "Unknown", 
                "Unknown", 
                "Unknown"), 
            sig=c("Signature 1A", "Signature 1B", "Signature 2", "Signature 3", "Signature 4", "Signature 5", "Signature 6",
                  "Signature 7", "Signature 8", "Signature 9", "Signature 10", "Signature 11", "Signature 12", "Signature 13", 
                  "Signature 14", "Signature 15", "Signature 16", "Signature 17", "Signature 18", "Signature 19", "Signature 20", 
                  "Signature 21", "Signature R1", "Signature R2", "Signature R3", "Signature U1", "Signature U2", "No Signature"
            )
        )
    }
    
    message(paste(phyloTree@patientID, " mutational signature information generation done!", sep=""))
    treeMSOutput <- list(sigsInput=sigsInput, mutSigsOutput=mutSigsOutput, df.aetiology=df.aetiology, patientID = patientID)
    return(treeMSOutput)
} 

## Branches' mutation collection
.treeMutationalBranches <- function(maf.dat, branchAlias, binary.matrix){
    binary.matrix <- as.data.frame(binary.matrix)
    binary.matrix$mut.id <- rownames(binary.matrix)
    ## get mutationalSigs-related  infomation
    maf_input <- maf.dat
    branchChar <- as.character(branchAlias$Branch)
    datChr <- data.frame(chr=as.character(maf_input$Chromosome), stringsAsFactors=FALSE)
    datChr$chr <- paste("chr", datChr$chr, sep="")
    datMutgene <-  maf_input$Hugo_Symbol
    mutId <- dplyr::select(tidyr::unite(maf_input, "mut.id", 
                                        Hugo_Symbol, Chromosome, 
                                        Start_Position, 
                                        Reference_Allele, Tumor_Seq_Allele2, 
                                        sep=":"), mut.id)
    mutSigRef <- data.frame(as.character(maf_input$Tumor_Sample_Barcode), 
                            datChr, maf_input$Start_Position, 
                            maf_input$End_Position, maf_input$Reference_Allele, 
                            maf_input$Tumor_Seq_Allele2, datMutgene, 
                            mutId, stringsAsFactors=FALSE)
    colnames(mutSigRef) <- c("Sample", 
                             "chr", "pos", 
                             "pos_end", "ref", 
                             "alt", "Hugo_Symbol", 
                             "mut_id")
    
    ## get branch infomation
    ls.branch <- branchChar[order(nchar(branchChar), branchChar)]
    branches <- strsplit(ls.branch, split='∩')
    
    ## generate mutational intersections for each branch
    mutBranchesOutput <- list()
    for (branch in branches){
        ## generate intersection's mut.id and get the mutation information in mutSigRef
        branch <- unlist(branch)
        ## generate the branch name
        branchName <- paste(branch, collapse="∩")
        branch.id <- append(branch, "mut.id")
        unbranch <- names(binary.matrix)[which(!(names(binary.matrix) %in% branch.id))]
        ## generate mutation intersection for specific branch
        branch.intersection <- dplyr::intersect(
            binary.matrix %>% dplyr::filter_at(branch, dplyr::all_vars(. == 1)), 
            binary.matrix %>% dplyr::filter_at(unbranch, dplyr::all_vars(. == 0))) 
        ## special situation: branch.intersection NULL
        if (nrow(branch.intersection) == 0){
            message(paste(branchName, ": Mutation Intersection Missing \n", sep=""))
            branch.mut <- data.frame(Sample=branchName, 
                                     chr=NA,
                                     pos=NA,
                                     pos_end=NA,
                                     ref=NA,
                                     alt=NA,
                                     Hugo_Symbol=NA,
                                     mut_id="NoSigTag",
                                     Alias=as.character(branchAlias[which(branchAlias$Branch == branchName), ]$Alias))
            mutBranchesOutput[[branchName]] <- branch.mut
            next()
        }
        
        branch.mut.id <- branch.intersection$mut.id
        
        ## data duplication
        branch.mut <- mutSigRef[which(mutSigRef$mut_id %in% branch.mut.id), ]
        branch.mut$Sample <- branchName
        branch.mut <- branch.mut[!duplicated(branch.mut),]
        branch.mut$Alias <- as.character(branchAlias[which(branchAlias$Branch == branchName), ]$Alias)
        
        ## generate branch mutation list
        mutBranchesOutput[[branchName]] <- branch.mut
    }
    return(mutBranchesOutput)
}







