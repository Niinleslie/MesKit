#' plotMutProfile
#'
#' @param maf the Maf object generated by readMaf
#' Classify SSNVs/Indels into Shared/P-shared/Private, Clonal/Subclonl
#' or Shared-Clonal/P-shared-Clonal/Private-Clonal/Shared-Subclonal/P-shared-SubClonal/Private-SubClonal 
#' @param patient.id select the specific patients. Default: NULL, all patients are included
#' @param driverGenesFile driver gene list. Default NULL
#' @param topGenesCount the number of genes print
#' @examples
#' plotMutProfile(maf, class = "SP", topGenesCount = 10)
#' @export plotMutProfile

genHeatmapPlotMatrix <- function(maf_data, topGenesCount = NULL) {
    if ("Driver_Mut" %in% colnames(maf_data)) {
        maf_data <- maf_data %>%
            dplyr::filter(Driver_Mut)
    }
 
    # split by patient
    patient.split <- maf_data %>%
        dplyr::select(Patient_ID, Tumor_Sample_Barcode) %>%
        dplyr::distinct() %>%
        dplyr::select(Patient_ID) %>%
        as.matrix() %>%
        as.vector() %>%
        as.character()

    if(length(unique(patient.split)) == 1){
        patient.split = NULL
    }

    # long -> wider
    mat <- maf_data %>%
        dplyr::group_by(Hugo_Symbol) %>%
        dplyr::mutate(total_barcode_count = sum(unique_barcode_count)) %>%
        dplyr::select(Hugo_Symbol,
                      Tumor_Sample_Barcode,
                      Mutation_Type,
                      total_barcode_count) %>%
        tidyr::pivot_wider(
            names_from = Tumor_Sample_Barcode,
            values_from = Mutation_Type,
            values_fn = list(Mutation_Type = multiHits)
        ) %>%
        dplyr::ungroup() %>%
        dplyr::arrange(dplyr::desc(total_barcode_count)) %>%       
        dplyr::select_if(function(x) {!all(is.na(x))}) %>%
        dplyr::slice(1:topGenesCount) %>%
        tibble::column_to_rownames(., "Hugo_Symbol") %>% 
        dplyr::select(-total_barcode_count) %>%
        as.matrix()

    return(list(mat, patient.split))
}

plotMutProfile <- function(maf,
                           patient.id = NULL,
                           class = "SP",
                           title = "Mutational profile",
                           topGenesCount = 10,
                           driverGenesFile = NULL) {
        
    class.options = c('SP', 'CS', 'SPCS')
    if(!class %in% class.options){
            stop("class can only be either 'SP', 'CS' or 'SPCS'")
    }


    # data frame
    maf_data <- classifyMut(maf, patient.id = patient.id, class, driverGenesFile)
    # View(maf_data)
 
    # matrix
    maf.plot <- genHeatmapPlotMatrix(maf_data, topGenesCount = topGenesCount)  
    mat <- maf.plot[[1]]
    patient.split <- maf.plot[[2]]
    # View(mat)

    #patient_id_cols <-
        #RColorBrewer::brewer.pal(length(unique(patient.split)), "Set3")
    #names(patient_id_cols) <- unique(patient.split)
#
    #patient_barcode <- maf_data %>%
        #dplyr::select(Patient_ID, Tumor_Sample_Barcode) %>%
        #dplyr::distinct() %>%
        #dplyr::mutate(color = patient_id_cols[patient.split]) 
#
    #sample_barcode <- patient_barcode$color
    #names(sample_barcode) <- patient_barcode$Tumor_Sample_Barcode


    multi_hit_exist = FALSE
    for (i in 1:nrow(mat)) {
        for (j in 1:ncol(mat)) {
            if (length(temp <- grep("Multi_hits", mat[i, j]))) {
                multi_hit_exist = TRUE
                break
            }
        }
    }
        
    col_type <- function(class) {
        if (class == "SP") {
            cols <- c("#3C5488FF", "#00A087FF", "#F39B7fFF")
            names(cols) <- c("Shared","P_shared", "Private")
        } else if (class == "CS") {
            cols <- c("#00A087FF", "#3C5488FF")
            names(cols) <- c("Clonal", "Subclonal")
        } else if (class == "SPCS") {
            cols <-
                c(
                    "#00A087FF",
                    "#3C5488FF",
                    "#8491B4FF",
                    "#F39B7FFF", 
                    "#E64B35FF",                    
                    "#4DBBD5FF"                    
                )
            names(cols) <-
                c(
                    "Shared_Clonal",
                    "Shared_Subclonal",
                    "P_shared_Clonal",
                    "P_shared_Subclonal",
                    "Private_Clonal",
                    "Private_Subclonal"                    
                )
        }
        
        return(cols)
    }

    alter_fun <- function(class){
        if(class == "SP"){
            l <- list(
            background = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = "#CCCCCC", col = NA)),
            Private = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SP")["Private"], col = NA)),
            Shared = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SP")["Shared"], col = NA)),
            P_shared = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SP")["P_shared"], col = NA)),
            Multi_hits = function(x, y, w, h)
                grid::grid.points(x, y, pch = 16, size = grid::unit(0.5, "char")
            ))
        }else if(class == "CS"){
            l <- list(
            background = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = "#CCCCCC", col = NA)),
            Clonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("CS")["Clonal"], col = NA)),
            Subclonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("CS")["Subclonal"], col = NA)),
            Multi_hits = function(x, y, w, h)
                grid::grid.points(x, y, pch = 16, size = grid::unit(0.5, "char") 
                ))
        }else if(class == "SPCS" ){
            l <- list(
            background = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = "#CCCCCC", col = NA)),
            Private_Clonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SPCS")["Private_Clonal"], col = NA)),
            Private_Subclonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SPCS")["Private_Subclonal"], col = NA)),
            Shared_Clonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SPCS")["Shared_Clonal"], col = NA)),
            Shared_Subclonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SPCS")["Shared_Subclonal"], col = NA)),
            P_shared_Clonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SPCS")["P_shared_Clonal"], col = NA)),
            P_shared_Subclonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col_type("SPCS")["P_shared_Subclonal"], col = NA)),
            Multi_hits = function(x, y, w, h)
                grid::grid.points(x, y, pch = 16, size = grid::unit(0.5, "char") 
            ))
        }
        return(l)            
    }

    heatmap_legend <- function(class, title = NULL) {
        param <- list(
            title = "Type",
            title_gp = grid::gpar(fontsize = 10, fontface = "bold"),
            at = names(col_type(class)),
            labels = sub("_", "-", names(col_type(class))),
            labels_gp = grid::gpar(fontsize = 10)
        )
        return(param)
    }        

    set.seed(123)
    ht <- suppressMessages(
        ComplexHeatmap::oncoPrint(
            mat,
            alter_fun = alter_fun(class),
            col = col_type(class),
            column_title = title,
            column_title_gp = grid::gpar(fontsize = 16, fontface = "bold"),
            row_title_gp = grid::gpar(fontsize = 10, fontface = "plain"),
            heatmap_legend_param = heatmap_legend(class, title),
            remove_empty_columns = TRUE,
            remove_empty_rows = TRUE,
            row_names_gp = grid::gpar(fontsize = 10, fontface = "italic"),
            column_names_gp = grid::gpar(fontsize = 10, fontface = "plain"),
            pct_digits = 2,
            pct_side = "right",
            row_names_side = "left",
            show_column_names = TRUE,
            column_split = patient.split,
            bottom_annotation = if(
                is.null(patient.split)) NULL else{
                ComplexHeatmap::HeatmapAnnotation(
                #df = data.frame(patient = colnames(mat)),
                df = data.frame(Patient = patient.split),
                show_annotation_name = FALSE,
                #col = list(patient = sample_barcode),
                simple_anno_size = unit(0.5, "cm")
                #show_legend = FALSE
                )}                
        )
    )



    if (multi_hit_exist) {
        ComplexHeatmap::draw(ht,
            heatmap_legend_list = list(
                ComplexHeatmap::Legend(
                    labels = "Multi_hits",
                    labels_gp = grid::gpar(fontsize = 10),
                    type = "points",
                    pch = 16
                    )
            )
            )
            #annotation_legend_list = if(
                #is.null(patient.split)) NULL else{
                #list(ComplexHeatmap::Legend(
                #title = "patient",
                #title_gp = grid::gpar(fontsize = 10, fontface = "bold"),
                #at = patient.split,
                ##labels = names(patient_id_cols),
                ##legend_gp = grid::gpar(fill = patient_id_cols),
                #labels_gp = grid::gpar(fontsize = 10)
                #))}
            #)
    } else {
      ComplexHeatmap::draw(ht
            #annotation_legend_list = if(
                #is.null(patient.split)) NULL else{
                #list(ComplexHeatmap::Legend(
                #title = "patient",
                #title_gp = grid::gpar(fontsize = 10, fontface = "bold"),
                #at = patient.split,
                ##labels = names(patient_id_cols),
                ##legend_gp = grid::gpar(fill = patient_id_cols),
                #labels_gp = grid::gpar(fontsize = 10)
                #))}
            )
  }

    #maf_data %>% dplyr::select(-unique_barcode_count)
    return(maf_data)
}
