#' plotMutProfile
#'
#' @param maf the Maf object generated by readMaf
#' @param driverGenesFile driver gene list. Default NULL
#' @param topGenesCount the number of genes print
#' @examples
#' plotMutProfile(maf, topGenesCount = 10)
#' @export plotMutProfile

mutType <- function(unique_sample_count,
                    Status,
                    total_count) {
    dplyr::case_when(
        unique_sample_count == 1 ~ paste0("Private_", Status),
        unique_sample_count == total_count ~ paste0("Shared_", Status),
        (1 < unique_sample_count) &
            (unique_sample_count < total_count) ~ paste0("P_shared_", Status)
    )
}

multiHits <- function(x) {
    if (length(x) > 1) {
        return(paste0(paste0(x, collapse = ";"), ";Multi_hits"))
    }
    else {
        return(x)
    }
}

genHeatmapPlotMatrix <-
    function(maf,
             topGenesCount = 20,
             driverGenesFile = NULL) {
        samples_total_count <- length(unique(maf@data$Tumor_Sample_Barcode))
        
        maf_data <-
            maf@data %>%
            tidyr::unite(
                "mutation_id",
                c(
                    "Chromosome",
                    "Start_Position",
                    "Reference_Allele",
                    "Tumor_Seq_Allele2"
                ),
                sep = ":",
                remove = FALSE
            )
        
        mutation_count <-
            maf_data %>%
            dplyr::group_by(mutation_id) %>%
            dplyr::summarise(unique_sample_count = dplyr::n_distinct(Tumor_Sample_Barcode))
        
        maf_data <- suppressMessages(
            maf_data %>%
            dplyr::left_join(mutation_count) %>%
            dplyr::filter(!is.na(Status)) %>%
            dplyr::mutate(mutation_type =
                              mutType(unique_sample_count,
                                      Status,
                                      samples_total_count)) %>%
            dplyr::group_by(Hugo_Symbol) %>%
            dplyr::mutate(max_sample_count = max(unique_sample_count)) %>%
            dplyr::select(Hugo_Symbol,
                          Tumor_Sample_Barcode,
                          mutation_type,
                          max_sample_count) %>%
            tidyr::pivot_wider(
                names_from = Tumor_Sample_Barcode,
                values_from = mutation_type,
                values_fn = list(mutation_type = multiHits)
            ) %>%
            dplyr::arrange(dplyr::desc(max_sample_count)) %>%
            dplyr::ungroup()
            )
        

        if (is.null(driverGenesFile)) {
           mat_data <-
                maf_data %>%
                dplyr::slice(1:topGenesCount)
       } else {
            geneSelect <-
                read.table(driverGenesFile, col.names = "gene_Name")$gene_Name
            mat_data <- maf_data %>%
                dplyr::filter(any(strsplit(Hugo_Symbol, ",|;") %in% geneSelect)) %>%
                dplyr::slice(1:topGenesCount)
        }
        #   View(mat_data)
        
        mat <- mat_data %>%
            dplyr::ungroup() %>%
            dplyr::select(-Hugo_Symbol, -max_sample_count) %>%
            as.matrix()
        rownames(mat) <- mat_data$Hugo_Symbol
     
        
        return(mat)
    }

plotMutProfile <-
    function(maf,
             title = "Mutational profile",
             topGenesCount = 10,
             driverGenesFile = NULL) {
        mat <-
            genHeatmapPlotMatrix(maf,
                                 topGenesCount = topGenesCount,
                                 driverGenesFile = driverGenesFile)
        # View(mat)
        
        types <- c(
                "Private_Clonal",
                "Private_Subclonal",
                "Shared_Clonal",
                "Shared_Subclonal",
                "P_shared_Clonal",
                "P_shared_Subclonal"
            )

        col <- c(ggsci::pal_npg("nrc")(10)[1:6])
        names(col) <- types

        alter_fun = list(
            background = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = "#CCCCCC", col = NA)),
            Private_Clonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col["Private_Clonal"], col = NA)),
            Private_Subclonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col["Private_Subclonal"], col = NA)),
            Shared_Clonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col["Shared_Clonal"], col = NA)),
            Shared_Subclonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col["Shared_Subclonal"], col = NA)),
            P_shared_Clonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col["P_shared_Clonal"], col = NA)),
            P_shared_Subclonal = function(x, y, w, h)
                grid::grid.rect(x, y, w * 0.9, h * 0.9,
                                gp = grid::gpar(fill = col["P_shared_Subclonal"], col = NA)),
            Multi_hits = function(x, y, w, h)
                grid::grid.points(x, y, pch = 16)
        )
        
        heatmap_legend_param <- list(
            title = "Alterations",
            at = types,
            labels = c(
                "Private clonal",
                "Private subclonal",
                "Shared clonal",
                "Shared subclonal",
                "P-shared clonal",
                "P-shared subclonal"
            )
        )
       
        ht <- suppressMessages(ComplexHeatmap::oncoPrint(
            mat,
            alter_fun = alter_fun,
            col = col,
            column_title = title,
            remove_empty_columns = TRUE,
            remove_empty_rows = TRUE,
            pct_digits = 2,
            pct_side = "right",
            row_names_side = "left",
            show_column_names = TRUE
        ))
        ComplexHeatmap::draw(ht,
                             #heatmap_legend_param = heatmap_legend_param,
                             heatmap_legend_list = list(
                                 ComplexHeatmap::Legend(
                                     labels = "Multi_hits",
                                     type = "points",
                                     pch = 16
                                 )
                             ))
    }